<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>RxNorm and Pharmacy Mapping • Rgemini</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="RxNorm and Pharmacy Mapping">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Rgemini</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cell_suppression_and_table1.html">Cell Suppression and Table 1</a></li>
    <li><a class="dropdown-item" href="../articles/daily_census.html">Daily Census</a></li>
    <li><a class="dropdown-item" href="../articles/data_coverage.html">Data Coverage</a></li>
    <li><a class="dropdown-item" href="../articles/epicare_and_readmission.html">Episodes of care and Readmission</a></li>
    <li><a class="dropdown-item" href="../articles/icd_to_ccsr.html">ICD to CCSR</a></li>
    <li><a class="dropdown-item" href="../articles/pharmacy_mapping.html">RxNorm and Pharmacy Mapping</a></li>
    <li><a class="dropdown-item" href="../articles/plotting_data_exploration.html">Plotting Functions - Easy Plots for Data Exploration</a></li>
    <li><a class="dropdown-item" href="../articles/plotting_theme.html">Plotting Functions - Themes &amp; Colors</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>RxNorm and Pharmacy Mapping</h1>
            
      

      <div class="d-none name"><code>pharmacy_mapping.Rmd</code></div>
    </div>

    
    
<hr>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>GEMINI receives raw pharmacy tables from participating sites. The
GEMINI team developed the RxNorm function (<code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>)
to identify drugs of interest more easily and faster, by using the
RxNorm API from the National Library of Medicine. Please refer to our
publication for details at <a href="https://academic.oup.com/jamiaopen/article/6/3/ooad062/7239332" class="external-link">GEMINI-RxNorm</a>.</p>
<p>Our team also developed a function
(<code><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation()</a></code>) to subsequently process
the matches identified by the RxNorm function, preparing them for
validation by a Subject Matter Expert (SME), and a function
(<code>add_validated_pharm_map()</code>) to append the SME-validated
matches into GEMINI’s Pharmacy Master Mapping file (for GEMINI staff
only).</p>
<p>The series of functions is designed to support analysts in
identifying orders for specific drug(s) of interest from the GEMINI
pharmacy data table. This vignette provides general guidelines for
effectively using these functions. Analysts are encouraged to consult
the function documentation for more detailed information.</p>
<div class="section level3">
<h3 id="design-overview">Design Overview<a class="anchor" aria-label="anchor" href="#design-overview"></a>
</h3>
<div class="figure" style="text-align: left">
<img src="figures/pharmacy_mapping/overall_design.png" class="r-plt" alt="&lt;div style='color:grey; font-size:12px; margin: 0px 0px 0px 20px'&gt;Input-Output Flow Diagram of the Pharmacy Mapping Workflow. Items in orange denote steps requiring analyst or SME engagement. Dashed lines indicate internal GEMINI operations.&lt;/div&gt;" width="100%"><p class="caption">
</p>
<div style="color:grey; font-size:12px; margin: 0px 0px 0px 20px">
Input-Output Flow Diagram of the Pharmacy Mapping Workflow. Items in
orange denote steps requiring analyst or SME engagement. Dashed lines
indicate internal GEMINI operations.
</div>

</div>
</div>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>Please note that the workflow as described here is only supported for
the following database versions:</p>
<ul>
<li><p>GEMINI staff: <code>drm_cleandb_v4_1_1</code> or newer</p></li>
<li><p>HPC4Health users: <code>gemini_h4h_template_v5_0_1</code> or
newer</p></li>
</ul>
<div class="section level4">
<h4 id="libraries-and-database">Libraries and Database<a class="anchor" aria-label="anchor" href="#libraries-and-database"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gemini-medicine.github.io/Rgemini/">Rgemini</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tomoakin/RPostgreSQL" class="external-link">RPostgreSQL</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wrathematics/getPass" class="external-link">getPass</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Connect to the DB that stores the Pharmacy Data Table</span></span>
<span><span class="va">db_con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDriver.html" class="external-link">dbDriver</a></span><span class="op">(</span><span class="st">"PostgreSQL"</span><span class="op">)</span>,</span>
<span>  dbname <span class="op">=</span> <span class="st">"db_name"</span>, <span class="co"># For HPC4Health users: connect to H4H template DB</span></span>
<span>  host <span class="op">=</span> <span class="st">"domain_name.ca"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">1234</span>, <span class="co"># placeholder for real port number</span></span>
<span>  user <span class="op">=</span> <span class="fu">getPass</span><span class="fu">::</span><span class="fu">getPass</span><span class="op">(</span><span class="st">"Username: "</span><span class="op">)</span>,</span>
<span>  password <span class="op">=</span> <span class="fu">getPass</span><span class="fu">::</span><span class="fu">getPass</span><span class="op">(</span><span class="st">"Password: "</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># HPC4Health users additionally need to set their data cut schema as follows:</span></span>
<span><span class="co"># dbSendQuery(db_con, "Set schema '&lt;datacut_name&gt;';")</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="guiding-example-insulin">Guiding example: Insulin<a class="anchor" aria-label="anchor" href="#guiding-example-insulin"></a>
</h4>
<p>In this vignette, we will use the hypothetical scenario below as a
basic guiding example. Each section will demonstrate how the functions
can be applied at different steps of the workflow to address this
question:</p>
<div style="background-color: #ede0a3; padding: 10px 15px; margin: 10px 0;">
<p><strong>Among encounters with a discharge date between January 1 and
March 31, 2022, what proportion had a pharmacy order for ‘insulin’
during their hospital stay?</strong></p>
</div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># query genc_ids in cohort of interest</span></span>
<span><span class="va">example_cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span></span>
<span>  <span class="va">db_con</span>,</span>
<span>  <span class="st">"SELECT genc_id</span></span>
<span><span class="st">   FROM admdad</span></span>
<span><span class="st">   WHERE discharge_date_time &gt;= '2022-01-01 00:00'</span></span>
<span><span class="st">   AND discharge_date_time &lt;= '2022-03-31 23:59';"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note: For the purpose of this vignette, we assume that the study
cohort has complete pharmacy data coverage. In practice, analysts should
check whether the study cohort has pharmacy data coverage. See <a href="https://gemini-medicine.github.io/Rgemini/articles/data_coverage.html"><em>data_coverage
vignette</em></a> for details.</p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="using-rxnorm_query">Using <code>rxnorm_query()</code><a class="anchor" aria-label="anchor" href="#using-rxnorm_query"></a>
</h2>
<p>The <strong><code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code></strong> function retrieves
rows from the GEMINI pharmacy data that RxNorm matched to the
user-specified drug term(s).</p>
<p>The function returns matched pharmacy entries in <strong>long
format</strong> with columns: <code>genc_id</code>,
<code>search_type</code> (which pharmacy column was found to have a
match), <code>raw_input</code> (value from that search_type),
<code>rxnorm_match</code> (which drug(s) of interest it is matched
with).</p>
<div class="section level3">
<h3 id="key-parameters">Key parameters<a class="anchor" aria-label="anchor" href="#key-parameters"></a>
</h3>
<p><strong>There are 5 primary parameters in the function:</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong><code>drug_name</code></strong>: Character vector containing
generic or brand names of the drug(s) of interest. We recommend
providing drug names in singular form (e.g, “insulin”, not “insulins”).
Users may also inspect the <code>lookup_pharmacy_mapping</code> table
and align naming conventions with previously used search terms (see
<code>rxnorm_match</code>).</li>
<li>
<strong><code>drug_class</code></strong>: Character vector with ATC
codes or names of drug classes. For example, for insulin, users can
provide ATC class “A10AB” or class name “Insulins and analogues for
injection, fast-acting”.</li>
<li>
<strong><code>return_unmatched</code></strong>: If
<code>FALSE</code> (default), the function only returns rows matching
the drug(s) of interest (in long format). If <code>TRUE</code>, the
function will return a list that additionally contains
<code>unmatched_rows</code> containing pharmacy entries that RxNorm did
not match to the searched drug (in wide format).</li>
<li>
<strong><code>cohort</code></strong>: Optional input allowing users
to provide a table containing <code>genc_ids</code> to search against.
If no input is provided, all rows in the pharmacy table will be
searched. When <code>return_unmatched</code> is TRUE the function
returns an error if no <code>cohort</code> input is provided because
returning the <code>unmatched_rows</code> for all pharmacy entries will
result in memory issues.</li>
<li>
<strong><code>return_drug_list</code></strong>: Optional parameter
allowing users to obtain a list of drugs (rxcui, drug_name) when running
<code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code> with <code>drug_class</code>. Default is
FALSE.</li>
</ol>
<p><strong>NOTE:</strong> There are 3 different ways to provide drug
inputs into this function:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Provide <code>drug_name</code> only:</strong> This is the
<strong>recommended way</strong>.<br>
</li>
<li>
<strong>Provide <code>drug_class</code> only:</strong> The function
will prompt user to confirm a list of ATC classes and the drugs
associated with the ATC classes. Users are indirectly querying based on
drug names and heavily rely on the drug name to ATC relationship from
RxNorm.
<ul>
<li>If <code>drug_class</code> is used, it is best to provide ATC codes
at the level between 2 to 4 according to the Anatomical Therapeutic
Chemical Classification system by the World Health Organization. See <a href="https://www.who.int/tools/atc-ddd-toolkit/atc-classification" class="external-link">WHO
ATC</a> for details. ATC codes at level 1 (e.g. “J: Antiinfective for
systemic use”) lacks specificity. ATC codes at level 5 (e.g. “J01CA04:
amoxicillin”) are too detailed that they cannot be searched as a drug
class in <code>drug_class</code><br>
</li>
<li>When <code>drug_class</code> is used, the function internally
converts the drug classes into a list of drug names and then queries
based on the drug names. We recommend users to turn on
<code>return_drug_list</code> when using <code>drug_class</code>. This
will output a list of drug names associated with the
<code>drug_class</code>, allowing users to confirm the list with an
SME.<br>
</li>
</ul>
</li>
<li>
<strong>Provide both <code>drug_name</code> and
<code>drug_class</code>:</strong> This will return a
<strong>union</strong> of the two searches.</li>
</ol>
</div>
<div class="section level3">
<h3 id="insulin-example">Insulin example<a class="anchor" aria-label="anchor" href="#insulin-example"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run RxNorm query</span></span>
<span><span class="va">rxnorm_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxnorm_query.html">rxnorm_query</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>, <span class="co"># DB containing the Pharmacy Data</span></span>
<span>  drug_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"insulin"</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="va">example_cohort</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># returns pharmacy entries RxNorm matched to the searched drug name</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rxnorm_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">genc_id</span>, <span class="va">row_num</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figures/pharmacy_mapping/rxnorm_query/fig1_insulin_simple_example.png" class="r-plt" alt="Dummy output of `rxnorm_query()`." width="80%"><p class="caption">
Dummy output of <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>.
</p>
</div>
</div>
<div class="section level3">
<h3 id="searching-for-combined-drugs">Searching for combined drugs<a class="anchor" aria-label="anchor" href="#searching-for-combined-drugs"></a>
</h3>
<p>The search for drugs commonly used in combination or drugs with
multiple active components is a bit more complex. There are 2
<strong>complementary</strong> strategies to search for combined
drugs.</p>
<ol style="list-style-type: decimal">
<li>Search by the individual drug names or the individual active
component names. Example 1.</li>
<li>Search by the brand name / generic name of the combined drug (if
available). Example 2.</li>
</ol>
<p>Depending on the drug(s) of interest, RxNorm’s sensitivity can be
very different for the 2 methods. Users should explore both strategies
to determine what works best for their needs.</p>
<p>Additionally, analysts should consult with the project SME to
identify relevant brand/generic names of the combined drug. Analysts can
also search for brand/generic names on the <a href="https://mor.nlm.nih.gov/RxNav/" class="external-link">RxNav website</a>.</p>
<hr style="border-top: 0.5px solid #ccc; margin: 20px 0;">
<p><strong>Example 1:</strong></p>
<ul>
<li>Drugs of interest: Drugs using Trimethoprim and Sulfamethoxazole in
combination.</li>
<li>User should input c(“trimethoprim”, “sulfamethoxazole”) into
<code>drug_name</code>, instead of combining the two drugs into one
customized entry like “trimethoprim-sulfamethoxazole” or
“trimethoprim/sulfamethoxazole”.</li>
<li>The search will return pharmacy orders matching <strong>one or
more</strong> of the two drugs.</li>
<li>To narrow down to orders where the two drugs are used in
combination, the user can then use <code>grepl</code> to identify
results with “|” to find matches where both Trimethoprim and
Sulfamethoxazole are found.</li>
<li>This combination is available under different brand names. If the
user has a list of these brand names, they can perform a second search
on the brand names (see Example 2).</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example 1 Trimethoprim and Sulfamethoxazole</span></span>
<span><span class="va">rxnorm_res_ex1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxnorm_query.html">rxnorm_query</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  drug_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trimethoprim"</span>, <span class="st">"sulfamethoxazole"</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="va">example_cohort</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rxnorm_res_ex1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"\\|"</span>, <span class="va">rxnorm_match</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">genc_id</span>, <span class="va">row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figures/pharmacy_mapping/rxnorm_query/fig2_trim_sulf.png" class="r-plt" alt="Dummy output of `rxnorm_query()`." width="80%"><p class="caption">
Dummy output of <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>.
</p>
</div>
<hr style="border-top: 0.5px solid #ccc; margin: 20px 0;">
<p><strong>Example 2:</strong></p>
<ul>
<li>Drug of interest: A drug with brand name Complera.</li>
<li>This drug contains three active components: Emtricitabine,
Rilpivirine, and Tenofovir Disoproxil Fumarate.</li>
<li>This combination of the three active components is only available
under the brand name Complera.</li>
<li>Users should therefore run <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code> input with
<code>drug_name = "complera"</code>.</li>
<li>A second search can be performed on the individual ingredients (see
Example 1) to potentially find additional matches. However, for
combination drugs that are available under one specific brand name,
searching by individual components can be less sensitive than directly
searching by brand name.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example 2 Complera</span></span>
<span><span class="va">rxnorm_res_ex2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxnorm_query.html">rxnorm_query</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  drug_name <span class="op">=</span> <span class="st">"complera"</span>,</span>
<span>  cohort <span class="op">=</span> <span class="va">example_cohort</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">rxnorm_res_ex2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="figures/pharmacy_mapping/rxnorm_query/fig3_complera.png" class="r-plt" alt="Dummy output of `rxnorm_query()`." width="80%"><p class="caption">
Dummy output of <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>.
</p>
</div>
</div>
<div class="section level3">
<h3 id="important-notes">Important notes<a class="anchor" aria-label="anchor" href="#important-notes"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>If a user inputs more than one search term in
<code>drug_name</code> or <code>drug_class</code>,
<code>rxnorm_match</code> may contain a pipe “|”. This indicates that a
given cell from the pharmacy table was matched to multiple search terms,
separated by the pipe.</p></li>
<li><p><code>rxnorm_match</code> only contains drug terms the user
searched for based on the input provided to <code>drug_name</code>
and/or <code>drug_class</code> (even if the pharmacy entry may contain
an additional drug; this will not appear as it wasn’t searched for by
the user).</p></li>
<li><p>RxNorm is a US-based tool. Although this is highly uncommon,
drugs that are only prescribed in Canada (and not in the US) cannot be
found by RxNorm. In addition, the current <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>
tool does not support searches based on Canadian brand names. Please use
the equivalent American brand name or generic name instead.</p></li>
<li><p>If <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code> returns an error saying “drug
could not be found”, please check the <a href="https://mor.nlm.nih.gov/RxNav/" class="external-link">RxNav website</a> as sometimes
there may be alternative searchable drug names based on the suggestion
from the search bar. For example, running <code>rxnmorm_query()</code>
with <code>drug_name = "Paxlovid"</code> returns an error. However, when
entering “Paxlovid” into the RxNav search bar, auto-completion will show
several results (e.g., “paxlovid 150 mg / 100 mg dose pack”). Users
should use the exact search results from RxNav as <code>drug_name</code>
inputs for <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>.</p></li>
</ol>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="using-prepare_pharm_for_validation">Using <code>prepare_pharm_for_validation()</code><a class="anchor" aria-label="anchor" href="#using-prepare_pharm_for_validation"></a>
</h2>
<p><strong>RxNorm is not a perfect tool and may generate false-positive
matches. A typical workflow we recommend is consulting an SME to
validate the output of <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>.</strong> This could
be a physician, pharmacist, or anybody with knowledge of medication.
They can ensure that the pharmacy records identified by RxNorm are
indeed accurate.</p>
<p><strong><code><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation()</a></code></strong> was
developed to streamline this validation process. It helps analysts to
process the RxNorm results into standardized frequency tables for
validation and to conduct subsequent analyses.</p>
<p><strong>3 key advantages of using this function:</strong></p>
<ul>
<li><p>It compares the RxNorm results against previously validated
mappings in the Pharmacy Master Mapping table, flagging matches that had
already been validated before by other projects. This allows SMEs to
focus primarily on new matches, streamlining the validation
process.</p></li>
<li><p>Pharmacy data includes multiple fields containing drug
information, which can contain redundant or inconsistent drug
information for the same pharmacy order. The function provides a
standardized way to handle these issues by applying hierarchical rules
to prioritize matches from certain fields over others. The hierarchical
rules are predefined by GEMINI SMEs.</p></li>
<li><p>It performs small cell suppression on data associated with less
than 6 encounters to protect patient privacy.</p></li>
</ul>
<div class="section level3">
<h3 id="key-parameters-1">Key parameters<a class="anchor" aria-label="anchor" href="#key-parameters-1"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<strong><code>dbcon</code></strong>: Database connection (same as
for <code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>). The function will then query the
<code>lookup_pharmacy_mapping</code> table containing previously
validated RxNorm matches.</li>
<li>
<strong><code>rxnorm_res</code></strong>: Object returned by
<code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code>.</li>
<li>
<strong><code>hierarchy</code></strong>: Flag indicating whether to
apply the predefined hierarchy filters to retain only highest-priority
drug information per pharmacy row.</li>
<li>
<strong><code>cell_suppression</code></strong>: Flag indicating
whether to apply small cell suppression to the outputs.</li>
<li>
<strong><code>outpath</code></strong>: Optional input specifying the
file path where the results will be saved. File export is only permitted
when <code>cell_suppression=TRUE</code>.</li>
<li>
<strong><code>custom_lookup</code></strong>: Internal GEMINI
analysts can optionally provide a custom version of the
<code>lookup_pharmacy_mapping</code> table (e.g., based on the latest
table in the Pharmacy Master Mapping DB). See function documentation for
more details.</li>
</ol>
<p><strong><code>NOTE</code></strong>:</p>
<ul>
<li>
<p>The hierarchy rules follow this order:</p>
<div style="background-color: #d9e7e5; padding:4px; font-size:13px;">
<p><strong>med_id_generic_name_raw &gt; med_id_brand_name_raw &gt;
med_id_hospital_code_raw &gt; med_id_din &gt; med_id_ndc &gt;
iv_component_type</strong></p>
</div>
</li>
<li><p>For each pharmacy row (identified by <code>row_num</code> of the
pharmacy table), only the highest-priority column that was matched to
the drug(s) of interest is retained as the “raw_input” for that row.
<strong>The default <code>hierarchy=TRUE</code> is highly
recommended</strong>. Only set to <code>FALSE</code> when applying
non-standard hierarchy rules and conducting further detailed
investigations.</p></li>
<li><p>With the hierarchy rule in place, it would be rare for drug
information from the lowest priority column to show up in the results
(i.e. <code>iv_component_type</code>). When that happens, it means that
no drug match was found for the other 5 higher priority columns.
However, it is possible that the higher priority columns suggests the
pharmacy order is for a diffferent drug (not the drug of interest):
e.g., <code>med_id_generic_name_raw = 'trimethoprim'</code>
vs. <code>iv_component_type = 'insulin'</code>. Therefore, when there
are <code>iv_component_type</code> entries in the returned results,
analysts should inspect the original pharmacy order corresponding to
those entries, to ensure the drug info at higher priority columns are
NOT pointing to a different drug.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="insulin-example-1">Insulin example<a class="anchor" aria-label="anchor" href="#insulin-example-1"></a>
</h3>
<div class="section level4">
<h4 id="pre-sme-validation">Pre SME validation<a class="anchor" aria-label="anchor" href="#pre-sme-validation"></a>
</h4>
<p>We have already run the RxNorm search for insulin in the above
section using <code>rxnorm_res &lt;- rxnorm_query(...)</code>. We can
now pass <code>rxnorm_res</code> to the second function
<code><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation()</a></code> to process the search
results into a frequency table for SME validation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>, <span class="co"># same DB connection used in rxnorm_query()</span></span>
<span>  rxnorm_res <span class="op">=</span> <span class="va">rxnorm_res</span>, <span class="co"># output of rxnorm_query()</span></span>
<span>  hierarchy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cell_suppression <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  outpath <span class="op">=</span> <span class="st">"path/to/output/folder/"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><br>The returned object <strong><code>prep_res</code> is a list
containing 2 data tables</strong> named ‘sme’ and ‘analyst’:</p>
<p><br><strong>$sme</strong> is the frequency table to be shared with
the SME for validation:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_res</span><span class="op">$</span><span class="va">sme</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">40</span><span class="op">:</span><span class="fl">45</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig2_freqtab_sme.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<details style="font-size: 13px;"><summary><span style="color:blue; font-size:13px; margin-left: 20px;">Expand to
understand the table</span>
</summary><ul>
<li>
<strong><code>row_id</code></strong>: a unique identifier for each
row of the table. It helps analysts to track entries in case of
accidental row deletions during the validation process.</li>
<li>
<strong><code>count</code></strong>: number of unique genc_ids
associated with each row. With cell_suppression = T, small counts less
than 6 encounters are suppressed to “&lt;6”.</li>
<li>
<strong><code>search_type</code>, <code>raw_input</code>,
<code>rxnorm_match</code></strong>: distinct RxNorm results.</li>
<li>
<strong><code>drug_group</code></strong>: general classification of
the drug in <code>rxnorm_match</code> based on previous mappings in
<code>lookup_pharmacy_mapping</code>. <code>drug_group = NA</code> for
drugs that have not been previously mapped.</li>
<li>
<strong><code>times_validated</code></strong>: number of times each
<code>raw_input ~ rxnorm_match</code> match has previously been
validated (0: never been validated, 1: validated by one project, 2+:
validated by two or more projects).</li>
<li>
<strong><code>SME_confirm</code>, <code>SME_comment</code></strong>:
fields for SME to fill out during validation.</li>
<li>Note that text values in <code>raw_input</code>,
<code>rxnorm_match</code> and <code>drug_group</code> have been
<strong>standardized</strong>. The function converts them to lowercase,
singularizes <code>rxnorm_match</code> and <code>drug_group</code>, and
handles special characters &amp; leading/trailing white spaces. See
in-package function <code><a href="../reference/normalize_text.html">normalize_text()</a></code> for details.</li>
</ul></details><p><br></p>
<p><strong>$analyst</strong> is the frequency table for analyst’s own
use:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_res</span><span class="op">$</span><span class="va">analyst</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig3_freqtab_ana.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<ul>
<li>Same table as <code>prep_res$sme</code>, with one additional column:
<code>pharm_row_num</code>.</li>
<li>
<strong><code>pharm_row_num</code> is a LIST storing
<code>row_num</code></strong> - a unique identifier for each row of the
pharmacy table. Analysts will need these values to retrieve
encounter-level data from the pharmacy table after SME-validation. See
<a href="#section-post-valid"><em>Guidelines for
post-validation</em></a>. Since <code>pharm_row_num</code> contains
encounter-level data, use of this table is restricted within the secure
HPC environment (e.g. NORA, HPC4Health). <strong>Egress Outside the HPC
Environment is Not Permitted</strong>. For illustration purposes of this
vignette, the last digits of <code>pharm_row_num</code> are hidden.</li>
</ul>
</div>
<div class="section level4">
<h4 id="sme-validation">SME validation<a class="anchor" aria-label="anchor" href="#sme-validation"></a>
</h4>
<p>When the user specifies a folder path to <code>outpath</code>, a file
named <code>pharmacy_mapping_for_SME.xlsx</code> is exported to the
corresponding folder. This file is the frequency table in
<code>prep_res$sme</code> in the user’s GlobalEnv. It is an aggregated
data file intended for sharing with the SME for validation.</p>
<p><strong>Analyst should clearly explain to the SME how to use this
table to conduct validation, following these key
guidelines:</strong></p>
<ol style="list-style-type: decimal">
<li>
<p>Columns highlighted in <span style="background-color: yellow;">yellow</span>: ‘SME_confirm’,
‘SME_comment’ should be filled out by the SME.</p>
<div style="padding-left: 40px;">
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig4_sme_valid_example_pre.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
</div>
</li>
<li><p><em>SME_confirm</em> should be a logical value of TRUE or FALSE.
Input TRUE to indicate that the SME verifies that <code>raw_input</code>
matches <code>rxnorm_match</code> (i.e. information in <span style="background-color: #ae8dda;">purple-highlighted columns</span> are
correct), otherwise FALSE. While analysts may modify the table or add
extra columns to meet project-specific needs, <em>SME_confirm</em>
should always be included.</p></li>
<li><p><em>SME_comment</em> is intended for SME to add comments, ask
questions, or flag exclusions. Even with a valid RxNorm match
(<code>SME_confirm = T</code>), the SME may still want to exclude a drug
from the study, which should be indicated in this column. Analysts
should clearly communicate the distinction between <em>SME_confirm</em>
(RxNorm validation) and <em>SME_comment</em> (e.g., cohort
inclusion).</p></li>
<li><p>In cases where <code>rxnorm_match</code> contains multiple
matches separated by a pipe (e.g. “cefuroxime | vancomycin”) and not all
matches are correct, the SME should still enter <em>SME_confirm</em> as
TRUE, and then specify the correct match(es) in <em>SME_comment</em>, or
manually correct the value in <code>rxnorm_match</code>.</p></li>
<li><p><em>times_validated</em> allows the SME to prioritize verifying
entries that haven’t been validated yet (times_validated = 0). However,
SMEs should also review previously validated entries and flag any errors
they find.</p></li>
<li><p>Missing <em>drug_group</em>: The SME can choose to fill out the
<em>drug_group</em> column if it is relevant for the project. For GEMINI
analysts, the <em>drug_group</em> field must be completed for database
upload; please reach out to GEMINI’s internal SME to complete this field
before adding the validated mappings to the database (see <a href="#section-db-upload"><em>Using
add_validated_pharm_map()</em></a>).</p></li>
<li><p>No rows should be deleted from the table.</p></li>
</ol>
<p><br>Below is an example of the expected results after SME
validation:</p>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig5_sme_valid_example.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<pre><code>- The SME entered 'T' to confirm that "insulin regular" correctly matches "insulin"; entered 'F' to indicate that "tazocin (fk) 4.5g in 100ml ns" does not match "insulin".
- The SME marked the drug in the 5th row as "exclude from cohort" to indicate that: although `raw_input` matches `rxnorm_match`, we want to exclude this drug entry from the study cohort.</code></pre>
</div>
<div class="section level4">
<h4 id="section-post-valid">Post SME validation<a class="anchor" aria-label="anchor" href="#section-post-valid"></a>
</h4>
<p>Upon receiving the validated mapping from the SME, analysts should at
least perform the following essential checks:</p>
<ul>
<li>Any accidental row deletion? Use <code>row_id</code> to detect and
track deletions.</li>
<li>Is <code>SME_confirm</code> fully populated with TRUE/FALSE? If not,
fill in the missing values or consult with the SME.</li>
<li>Review <code>SME_comment</code> and address questions, clarify
uncertainties, and note any cohort exclusions.</li>
</ul>
<p>After completing sanity checks, analyst should save the cleaned
validated mappings and proceed with their analyses.</p>
<p><br>Now that the SME has validated the RxNorm matches: How do
analysts identify entries from the <code>pharmacy table</code>
corresponding to the confirmed matches?</p>
<div style="background-color: #d9e7e5; padding: 10px 15px; margin: 10px 0;">
<p>It is important to understand the following key variables linking
<code>$sme</code>, <code>$analyst</code> and the
<code>pharmacy table</code>:</p>
<li>
[$sme] and [$analyst]: linked via <code>sme.row_id</code> ↔︎
<code>analyst.row_id</code>
</li>
<li>
[$analyst] and [pharmacy]: linked via <code>analyst.pharm_row_num</code>
↔︎ <code>pharmacy.row_num</code>
</li>
<p><strong>Analysts should use these key variables to link the validated
RxNorm matches with the pharmacy table</strong>, rather than using the
raw <code>rxnorm_matches</code> or other merging strategies. Please
carefully go through the steps in the example below to understand how
the linkages work.</p>
</div>
<hr style="border-top: 0.5px solid #ccc; margin: 20px 0;">
<p><strong>Insulin example: To identify all encounters with an insulin
order (based on the validated RxNorm matches), the analyst now needs to
complete the following steps:</strong></p>
<p style="padding-left: 35px; margin-top:20px;">
<strong>STEP 1.</strong> Load the prepared pharmacy R object.
</p>
<div style="padding-left: 40px; font-size:13px">
When the analyst ran
<code>prepare_pharm_for_validation(..., outpath = "path/to/output/folder/")</code>,
the function saved an R object named
<code>pharm_res_INTERNAL_USE_ONLY.rds</code>. This R object is
equivalent to <code>prep_res</code>, containing the <code>$sme</code>
and <code>$analyst</code> tables. The R object offers a convenient way
for analysts to resume analysis after SME validation without the need to
re-run the time-consuming steps <code>rxnorm-query()</code> &amp;
<code><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation()</a></code>:
</div>
<div style="padding-left: 40px">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">saved_robject</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"path/to/output/folder/pharm_res_INTERNAL_USE_ONLY_yyyymmdd.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">saved_robject</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig6_rds_object.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
</div>
<p style="padding-left: 35px; margin-top:20px;">
<strong>STEP 2.</strong> Cross-reference with SME-validated file to
identify the list of pharmacy orders (<code>pharm_row_num</code>) of
interest to the study.
</p>
<div style="padding-left: 40px">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###################################################</span></span>
<span><span class="co"># Read in cleaned SME validated mapping file from folder</span></span>
<span><span class="va">sme_valid_clean</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"your_path_to/pharmacy_mapping_for_SME_validated.xlsx"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sme_valid_clean</span><span class="op">)</span> <span class="co"># mock validation for demonstration purposes, not real validation</span></span>
<span><span class="co"># #   row_id count             search_type                     raw_input rxnorm_match drug_group times_validated SME_confirm         SME_comment</span></span>
<span><span class="co"># # 1      1  1271 med_id_generic_name_raw               insulin regular      insulin    insulin              2+        TRUE</span></span>
<span><span class="co"># # 2      2   722 med_id_generic_name_raw             insulin humulin r      insulin    insulin              2+        TRUE</span></span>
<span><span class="co"># # 3      3   671 med_id_generic_name_raw tazocin (fk) 4.5g in 100ml ns      insulin    insulin               0        FALSE</span></span>
<span><span class="co"># # 4      4   600   med_id_brand_name_raw                         lilly      insulin    insulin               0        TRUE</span></span>
<span><span class="co"># # 5      5   332              med_id_din                      00586714      insulin    insulin               0        TRUE exclude from cohort</span></span>
<span></span>
<span><span class="co">###################################################</span></span>
<span><span class="co"># Filter SME-validated frequency table to rows of interest</span></span>
<span><span class="va">insulin</span> <span class="op">&lt;-</span> <span class="va">sme_valid_clean</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SME_confirm</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># filter drug entries to validated matches</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SME_comment</span> <span class="op">!=</span> <span class="st">"exclude from cohort"</span><span class="op">)</span> <span class="co"># exclude entries not relevant for the study</span></span>
<span></span>
<span><span class="co">###################################################</span></span>
<span><span class="co"># Identify `pharm_row_num` corresponding to drug(s) of interest in the R object saved to analyst's folder</span></span>
<span></span>
<span><span class="co">## Extract `row_id` corresponding to drug(s) of interest,</span></span>
<span><span class="co">##  since `row_id` is a consistent identifier pre- &amp; post- validation.</span></span>
<span><span class="co">##  If for some reasons, `row_id` was altered unexpectedly, use `raw_input` instead.</span></span>
<span><span class="va">insulin_row_id</span> <span class="op">&lt;-</span> <span class="va">insulin</span><span class="op">$</span><span class="va">row_id</span></span>
<span></span>
<span><span class="va">insulin_pharm_row_num</span> <span class="op">&lt;-</span> <span class="va">saved_robject</span><span class="op">$</span><span class="va">analyst</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">row_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">insulin_row_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">pharm_row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># note that `pharm_row_num` is stored as list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># unlist to covert to vector</span></span>
<span></span>
<span><span class="va">insulin_pharm_row_num</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="co"># mock example of row numbers</span></span>
<span><span class="co"># [1] "54781..." "54781..." "54781..." "54786..." "54786..."</span></span></code></pre></div>
</div>
<p style="padding-left: 35px; margin-top:20px;">
<strong>STEP 3.</strong> Identify encounters (<code>genc_id</code>)
associated with the validated pharmacy orders.
</p>
<div style="padding-left: 40px; font-size:13px">
<strong>$pharm_row_num</strong> values (e.g. 54781.., 54786..)
correspond to <strong>row_num</strong> of the pharmacy table, which is
the unique identifier for <em>each pharmacy row</em>. Therefore,
analysts can use them to trace each entry back to the original pharmacy
table to identify <code>genc_ids</code> with <strong>at least one
insulin order during their hospitalization</strong>:
</div>
<div style="padding-left: 40px">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Send a list of row_num as a temp table in case the number of row_num is very long,</span></span>
<span><span class="co"># since dbGetQuery has a character limit.</span></span>
<span></span>
<span><span class="va">insulin_pharm_row_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>row_num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">insulin_pharm_row_num</span><span class="op">)</span><span class="op">)</span> <span class="co"># ensure it's data.frame</span></span>
<span></span>
<span><span class="co"># write the row_num into a temp table to improve query efficiency</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">db_con</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pg_temp"</span>, <span class="st">"temp_row_num"</span><span class="op">)</span>, <span class="va">insulin_pharm_row_num</span>,</span>
<span>  temporary <span class="op">=</span> <span class="cn">TRUE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"SELECT p.*</span></span>
<span><span class="st">                 FROM pharmacy p</span></span>
<span><span class="st">                 INNER JOIN temp_row_num t on t.row_num=p.row_num;"</span><span class="op">)</span></span>
<span><span class="va">pharm_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">db_con</span>, <span class="va">query</span><span class="op">)</span> <span class="co"># pull pharm rows containing validated drugs</span></span>
<span></span>
<span><span class="co">#### alternative query (less efficient), if you don't have write access to create temp table in db_con</span></span>
<span><span class="co"># query &lt;- paste0("SELECT row_num, genc_id</span></span>
<span><span class="co">#                  FROM pharmacy</span></span>
<span><span class="co">#                  WHERE row_num IN (", paste(insulin_pharm_row_num, collapse=", "), ");")</span></span>
<span></span>
<span><span class="co"># Encounters associated with the validated insulin entries:</span></span>
<span><span class="va">insulin_cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pharm_tab</span><span class="op">$</span><span class="va">genc_id</span><span class="op">)</span> <span class="co"># i.e. genc_ids with at least 1 insulin prescription order in the pharmacy table</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">insulin_cohort</span><span class="op">)</span></span>
<span><span class="co"># [1] 4088</span></span>
<span><span class="co">## A total 4088 encounters (7.7%) in the example cohort had</span></span>
<span><span class="co">## at least 1 insulin order during their hospital stay,</span></span>
<span><span class="co">## assuming cohort has consistent pharmacy data coverage.</span></span></code></pre></div>
</div>
<br><div style="padding-left: 40px; font-size:13px">
In the pharmacy table, one encounter can have multiple pharmacy orders.
<strong>row_num</strong> is therefore also useful for <em>tracing
order-level information</em>. For example, instead of identifying
encounters with at least one insulin prescription, the study is now
interested in identifying encounters who had <strong>at least one
insulin prescription during the first 24 hours of inpatient
admission</strong>. The analyst can use row number along with order
date-time to refine the cohort:
</div>
<div style="padding-left: 40px">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Pull pharm rows containing validated drugs</span></span>
<span><span class="co"># write the row_num into a temp table to improve query efficiency</span></span>
<span><span class="fu">dbWritetable</span><span class="op">(</span><span class="va">db_con</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pg_temp"</span>, <span class="st">"temp_row_num"</span><span class="op">)</span>, <span class="va">insulin_pharm_row_num</span>,</span>
<span>  temporary <span class="op">=</span> <span class="cn">T</span>, row.names <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"SELECT p.*</span></span>
<span><span class="st">                 FROM pharmacy p</span></span>
<span><span class="st">                 INNER JOIN temp_row_num t on t.row_num=p.row_num;"</span><span class="op">)</span></span>
<span><span class="va">pharm_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">db_con</span>, <span class="va">query</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pull admission_date_time for the study cohort</span></span>
<span><span class="va">adm_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"SELECT genc_id, admission_date_time</span></span>
<span><span class="st">   FROM admdad</span></span>
<span><span class="st">   WHERE genc_id IN ("</span>, <span class="co"># this approach only suitable for a small number of genc_ids,</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">example_cohort</span><span class="op">$</span><span class="va">genc_id</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">");"</span> <span class="co"># if cohort is large, send the list of genc_id as a temp table instead</span></span>
<span><span class="op">)</span></span>
<span><span class="va">adm_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">db_con</span>, <span class="va">adm_query</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>admission_date_time <span class="op">=</span> <span class="fu">ymd_hm</span><span class="op">(</span><span class="va">admission_date_time</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Impute missing time in `med_start_date_time` with 00h:00m</span></span>
<span><span class="va">pharm_tab</span> <span class="op">&lt;-</span> <span class="va">pharm_tab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>med_start_date_time <span class="op">=</span> <span class="fu">parse_date_time</span><span class="op">(</span><span class="va">med_start_date_time</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ymd HM"</span>, <span class="st">"ymd"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Encounters with validated insulin entries within the first 24 hours of inpatient admission:</span></span>
<span><span class="va">insulin_24hr_cohort</span> <span class="op">&lt;-</span> <span class="va">pharm_tab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">adm_tab</span>, by <span class="op">=</span> <span class="st">"genc_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">med_start_date_time</span> <span class="op">&lt;=</span> <span class="va">admission_date_time</span> <span class="op">+</span> <span class="fu">hours</span><span class="op">(</span><span class="fl">24</span><span class="op">)</span>,</span>
<span>    <span class="va">med_start_date_time</span> <span class="op">&gt;=</span> <span class="va">admission_date_time</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">genc_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">insulin_24hr_cohort</span><span class="op">)</span></span>
<span><span class="co"># [1] 1982</span></span>
<span><span class="co">## A total 1982 encounters (3.7%) in the example cohort had</span></span>
<span><span class="co">## at least 1 insulin order din their first 24 hours of admission,</span></span>
<span><span class="co">## assuming cohort has consistent pharmacy data coverage.</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="more-complex-scenarios">More complex scenarios<a class="anchor" aria-label="anchor" href="#more-complex-scenarios"></a>
</h3>
<div class="section level4">
<h4 id="setting-hierachy-to-false">Setting hierachy to FALSE<a class="anchor" aria-label="anchor" href="#setting-hierachy-to-false"></a>
</h4>
<p>The pharmacy table has multiple fields containing drug information.
For a single pharmacy order, RxNorm may match these fields to the same
drug or different drugs.</p>
<p>Setting <strong>hierarchy=TRUE</strong> prioritizes fields to ensure
a one-to-one match (i.e. one order to one drug) to reduce unnecessary
mapping efforts. When <strong>hierarchy=FALSE</strong>, all matching
entries are returned without applying hierarchy rules to the
drug-containing fields. While setting hierarchy to FALSE is generally
discouraged, it may be useful for project-specific scenarios requiring
no or non-standard hierarchy rules. To apply customized hierarchy rules,
analysts could refer to the detailed code logic of applying hierarchical
filters in the <code><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation()</a></code> function.</p>
<hr style="border-top: 0.5px solid #ccc; margin: 20px 0;">
<p>Insulin example, <code>hierarchy=T</code>
vs. <code>hierarchy=F</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  rxnorm_res <span class="op">=</span> <span class="va">rxnorm_res</span>,</span>
<span>  hierarchy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cell_suppression <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">prep_res_nohier</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  rxnorm_res <span class="op">=</span> <span class="va">rxnorm_res</span>,</span>
<span>  hierarchy <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cell_suppression <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig7_prepare_pharm_nohier_run.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<pre><code>- When `hierarchy == FALSE` the most frequent raw_input is DIN number "00586714". 
- When `hierarchy == TRUE` DIN number "00586714" is not the most frequent value because the function now ignores any DIN matches for pharmacy entries that have already been matched to "insulin" based on `med_id_generic_name_raw`, `med_id_brand_name_raw`, or `med_id_hospital_code_raw` (which are prioritized according to the hierarchy rules).
- Below is a mock example of ONE pharmacy order from ONE encounter:</code></pre>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig8_nohier_example.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
<pre><code>- For this order, the columns `med_id_generic_name_raw`, `med_id_brand_name_raw`, and `med_id_din` each contain drug information, all of which are matched to "insulin" by RxNorm. When `hierarchy == TRUE`, only the row with "med_id_generic_name_raw = insulin regular 100 unit/mL" is included in the result frequency table, while other rows are dropped, ensuring a one-to-one match. When `hierarchy == FALSE` all rows will be included, therefore, the redundant information "med_id_din = 00586714" and "med_id_brand_name_raw = Novolin" are returned and contribute to the frequency count.</code></pre>
</div>
<div class="section level4">
<h4 id="unmatched-results">Unmatched results<a class="anchor" aria-label="anchor" href="#unmatched-results"></a>
</h4>
<p>Recall that with <strong>return_unmatched=TRUE</strong> in the
previous <code>rxnorm_res &lt;- rxnorm_query(...)</code> function, the
returned object contains 2 items - matched and unmatched results. When
<code>rxnorm_res</code> contains unmatched results,
<strong><code><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation()</a></code> will automatically
process them along with the matched results to facilitate SME
validation.</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rxnorm_res_unmatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxnorm_query.html">rxnorm_query</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  drug_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"insulin"</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="va">example_cohort</span>,</span>
<span>  return_unmatched <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">prep_res_unmatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  rxnorm_res <span class="op">=</span> <span class="va">rxnorm_res_unmatch</span>,</span>
<span>  hierarchy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cell_suppression <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prep_res_unmatch</span><span class="op">)</span></span>
<span><span class="co"># [1] "sme" "analyst" "unmatched_rows"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">prep_res_unmatch</span><span class="op">$</span><span class="va">unmatched_rows</span>, <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig9_prepare_pharm_unmatch.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<ul>
<li>An additional result table
<strong>prep_res_unmatch$unmatched_rows</strong> is returned. This table
is saved as the second tab of the .xlsx file when an outpath is
provided.</li>
<li>
<strong>$unmatched_rows</strong> is a frequency table of all drug
entries that did not match to the drug(s) of interest.</li>
<li>
<em>historically_mapped_to_drug</em> and
<em>historically_mapped_to_drug_group</em> provide historical mapping
information based on a search against the existing mappings in the
master file. Distinct mappings from different projects are separated by
‘||’. See function documentation for details.
<div style="padding-left: 40px; padding-top:8px; font-size:12px">
e.g. Drug information for the top 8 rows have not been previously
mapped, except for “row_id=7”, which was mapped to drug “dalteparin” and
drug_group “low molecular weight heparin”.
</div>
</li>
<li>Note that this secondary search is <strong>a broad search against
all mapped drugs, and it is NOT specific to the user’s drug(s) of
interest</strong>. Users may use regex search to identify their drug(s)
of interest.</li>
<li>We particularly recommend inspecting unmatched results when users
suspect that the RxNorm search had low sensitivity/missed certain
entries that could be relevant for the study (e.g., observed prescribing
rates are lower than expected).</li>
</ul>
<details style="padding-left:80px; margin-top:-10px; font-size:11px"><summary><span style="color:grey; font-size:12px;">Expand to see an
example</span>
</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Step 1. identify entries that have previously been mapped to insulin</span></span>
<span><span class="va">insulin_hist</span> <span class="op">&lt;-</span> <span class="va">prep_res_unmatch</span><span class="op">$</span><span class="va">unmatched_rows</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"insulin"</span>, <span class="va">historically_mapped_to_drug</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"insulin"</span>, <span class="va">historically_mapped_to_drug_group</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">insulin_hist</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Alternative for Step 1, analysts may also use regex on all columns in the unmatched output</span></span>
<span><span class="co">## to check if RxNorm/historical mappings have missed any entries that might correspond to the drug of interest</span></span>
<span><span class="co"># insulin_unmatched &lt;- prep_res_unmatch$unmatched_rows[</span></span>
<span><span class="co">#  prep_res_unmatch$unmatched_rows[</span></span>
<span><span class="co">#   , Reduce(`|`, lapply(.SD, grepl, pattern = "insulin|00586714|humulin", ignore.case = TRUE)),</span></span>
<span><span class="co">#    .SDcols = colnames(prep_res_unmatch$unmatched_rows) # search all columns</span></span>
<span><span class="co">#  ]</span></span>
<span><span class="co"># ]</span></span>
<span></span>
<span><span class="co">## Step 2. analysts can then extract the original pharmacy data based on info in the frequency table to obtain the relevant pharmacy row_num values</span></span>
<span><span class="co"># Recall that prepare_pharm_for_validation() standardizes text values in rxnorm_res, so we need to do the same here before searching for matches</span></span>
<span><span class="co"># this can be achieved by applying the utils function `normalize_text()` in the package</span></span>
<span><span class="va">rxnorm_res_unmatch</span><span class="op">$</span><span class="va">unmatched_rows</span><span class="op">[</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rxnorm_res_unmatch</span><span class="op">$</span><span class="va">unmatched_rows</span><span class="op">)</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">normalize_text</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># then merge any relevant entries identified in the unmatched results with the unmatched RxNorm output</span></span>
<span><span class="co"># to identify original pharmacy rows and their corresponding row_num</span></span>
<span><span class="va">insulin_hist_pharm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">rxnorm_res_unmatch</span><span class="op">$</span><span class="va">unmatched_rows</span>, <span class="va">insulin_hist</span>, all.x <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig10_filter_pharm_unmatch.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></details><ul>
<li>Columns starting with <code>SME_</code> are for SME to fill out.
<div style="padding-left: 40px; padding-top:8px; font-size:12px">
e.g. if the SME identifies a drug entry in column
<code>med_id_brand_name_raw</code> that should have been matched to
“insulin” but was missed by RxNorm (i.e. a false negative), in
<code>SME_mapped_search_type</code> they should enter
“med_id_brand_name_raw”, in <code>SME_mapped_search_type</code> they
should enter “insulin”, and in <code>SME_mapped_drug_group</code> they
could provide drug classification information, if available.
</div>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="considering-routes-of-administration">Considering routes of administration<a class="anchor" aria-label="anchor" href="#considering-routes-of-administration"></a>
</h4>
<p>Some research projects are specifically interested in drugs
administered via specific routes (e.g., topical vs. oral antibiotics).
In such cases, the general approach we recommend for analysts is to
first complete the RxNorm validation regardless of route information,
and then create a separate frequency table for <code>route</code>
entries among the validated pharmacy rows. An SME can then indicate
which routes should be included/excluded, allowing the analyst to filter
the pharmacy entries accordingly to obtain the final list of relevant
pharmacy orders.</p>
<details><summary><span style="color:blue; font-size:13px">Expand to see an example of how
to filter insulin orders based on routes of interest</span>
</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Run rxnorm as usual</span></span>
<span><span class="va">rxnorm_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxnorm_query.html">rxnorm_query</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  drug_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"insulin"</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="va">example_cohort</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Prepare frequency table for drug(s) of interest as usual</span></span>
<span><span class="va">prep_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_pharm_for_validation.html">prepare_pharm_for_validation</a></span><span class="op">(</span></span>
<span>  dbcon <span class="op">=</span> <span class="va">db_con</span>,</span>
<span>  rxnorm_res <span class="op">=</span> <span class="va">rxnorm_res</span>,</span>
<span>  hierarchy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cell_suppression <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Extract pharmacy data corresponding to insulin</span></span>
<span><span class="co">## (for illustration purposes, we assume all matches in rxnorm_res are confirmed by SME)</span></span>
<span><span class="va">insulin_pharm_row_num</span> <span class="op">&lt;-</span> <span class="va">prep_res</span><span class="op">$</span><span class="va">analyst</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">pharm_row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate frequency table for routes corresponding to insulin, and share with SME</span></span>
<span><span class="va">route_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"SELECT genc_id, route</span></span>
<span><span class="st">    FROM pharmacy</span></span>
<span><span class="st">    WHERE row_num IN ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">insulin_pharm_row_num</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="co"># filter to rows with validated drugs</span></span>
<span>  <span class="st">");"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create frequency table of `route` column</span></span>
<span><span class="va">freqtab_route</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">db_con</span>, <span class="va">route_query</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>route <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># minimal standardization, analysts should clean up the raw values as needed</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># can be merged with lookup_pharmacy_route to obtain previous route mappings</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">genc_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    row_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span>,</span>
<span>    SME_confirm <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># to be filled out by SME</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&lt;</span> <span class="fl">6</span>, <span class="st">"suppressed (n &lt; 6)"</span>, <span class="va">n</span><span class="op">)</span> <span class="co"># apply cell suppression</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 22 × 4</span></span>
<span><span class="co">#    route              n row_id SME_confirm</span></span>
<span><span class="co">#    &lt;chr&gt;          &lt;int&gt;  &lt;int&gt; &lt;lgl&gt;</span></span>
<span><span class="co">#  1 iv              2099      1 NA</span></span>
<span><span class="co">#  2 subcut          1167      2 NA</span></span>
<span><span class="co">#  3 .route           652      3 NA</span></span>
<span><span class="co">#  4 iv continuous    476      4 NA</span></span>
<span><span class="co">#  5 sc               330      5 NA</span></span>
<span><span class="co">#  6 intravenous      308      6 NA</span></span>
<span><span class="co">#  7 iv direct        299      7 NA</span></span>
<span><span class="co">#  8 iv infus         239      8 NA</span></span>
<span><span class="co">#  9 iv-direct/push   132      9 NA</span></span>
<span><span class="co"># 10 subcutaneous     104     10 NA</span></span>
<span><span class="co"># ℹ 12 more rows</span></span>
<span><span class="co"># ℹ Use `print(n = ...)` to see more rows</span></span>
<span></span>
<span><span class="co">## Next, let's assume the SME marks routes with the row_id = c(1, 4, 6, 7, 9)</span></span>
<span><span class="co">## as routes of interest. The analyst can then use this information to further</span></span>
<span><span class="co">## filter the insulin orders to those administered via these routes:</span></span>
<span></span>
<span><span class="va">iv_route</span> <span class="op">&lt;-</span> <span class="va">freqtab_route</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">row_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># identify genc_ids with insulin administered via routes of interest</span></span>
<span><span class="va">pharm_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"SELECT *</span></span>
<span><span class="st">    FROM pharmacy</span></span>
<span><span class="st">    WHERE row_num IN ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">insulin_pharm_row_num</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>  <span class="st">") AND route IN ('"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">iv_route</span>, collapse <span class="op">=</span> <span class="st">"', '"</span><span class="op">)</span>, <span class="st">"');"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># filter pharmacy data to insulin that were administered via the routes of interest</span></span>
<span><span class="va">iv_insulin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">db_con</span>, <span class="va">pharm_query</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>Note that the <code>route</code> column in the <code>pharmacy</code>
table is not standardized. However, previous route mappings can be found
in the <code>lookup_pharmacy_route</code> table in the database. We
recommend merging the route frequency table with the lookup table to
facilitate route inclusions/exclusions. Researchers may need to perform
additional route mapping for their drugs of interest.</li>
<li>In scenarios where drug and route information may interact and need
to be considered simultaneously, analysts should include all drug
(<code>rxnorm_match</code> x <code>route</code>) combinations in this
frequency table.</li>
<li>If route information is missing for certain pharmacy entries,
analysts may need to investigate additional pharmacy columns to search
for route-related information, or identify plausible routes based on
medication DIN.</li>
</ul></details><p><br></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="section-db-prep">Preparing SME-validated mappings for database integration<a class="anchor" aria-label="anchor" href="#section-db-prep"></a>
</h2>
<p>Once the SME-validated mappings are finalized, they should be
integrated into GEMINI’s Pharmacy Master Mapping database.</p>
<p><strong>GEMINI Analysts</strong> are expected to document and perform
the integration.</p>
<p><strong>HPC4Health users</strong> are encouraged to contribute their
mappings for inclusion in the our database, enabling reuse in future
work.</p>
<p>To prepare your mapping for database upload, please follow these
steps:</p>
<p><strong>Step 1:</strong> Format the SME-validated mapping file
(.xlsx) according to the following requirements:</p>
<ul>
<li>The file must <strong>have and only have</strong> the following
columns from the SME-validated frequency table:
<code>search_type</code>, <code>raw_input</code>,
<code>rxnorm_match</code>, <code>SME_confirm</code>, and
<code>drug_group</code>.<br>
</li>
<li>
<em>SME_confirm</em> must be logical values. <strong>Only include
rows with <code>SME_confirm=TRUE</code></strong>, non-True rows will
cause mapping upload to stop.<br>
</li>
<li>In some cases, <code>rxnorm_match</code> may contain multiple
matches separated by a pipe (e.g. “cefuroxime | vancomycin”). If the SME
confirms only one or some of the matches, the analyst <strong>should
edit <code>rxnorm_match</code> to retain only the confirmed
entries</strong>.<br>
</li>
<li>The column <em>drug_group</em> should be included if the SME has
filled it out. If not, this column can be left empty for now, however,
GEMINI analysts should reach out to GEMINI’s internal SME for filling
out this column upon running (see <a href="#section-db-upload"><em>Using
add_validated_pharm_map()</em></a>).<br>
</li>
<li>If <em>unmatched rows</em> are examined and false negative entries
are found, the analyst should extract and add these mappings to the
final mapping file. To differentiate these manually identified entries
from those mapped by RxNorm, a <strong>prefix “manual_”</strong> should
be added to the mapped drugs. See ‘False negatives’ below for
details.<br>
</li>
<li>Save the formatted final mapping as a <strong>.csv (required format)
file</strong> to folder.</li>
</ul>
<p><strong>Step 2:</strong></p>
<ul>
<li>
<strong>For HPC4Health users</strong>:
<ul>
<li>Please submit your validated and formatted mapping file to <a href="mailto:support@gemini-hpc.ca" class="email">support@gemini-hpc.ca</a>. The GEMINI team will then
integrate your mappings to the master pharmacy mapping database.</li>
</ul>
</li>
<li>
<strong>For GEMINI analysts</strong>:
<ul>
<li>Document the mapping information on the <a href="https://app.smartsheet.com/sheets/hgGCpcp9PhQ25RfW9pPpQjm5jJ9mxwmRmhQRQHP1?view=grid" class="external-link">Solo
mapping tracker</a><br>
</li>
<li>Run the <code>GEMINIpkg</code> function <a href="#section-db-upload">add_validated_pharm_map()</a>, which uploads
the finalized mappings to the Pharmacy Master Mapping database.</li>
</ul>
</li>
</ul>
<div class="section level3">
<h3 id="insulin-example-2">Insulin example<a class="anchor" aria-label="anchor" href="#insulin-example-2"></a>
</h3>
<p>Prepare the SME validated pharmacy mapping file to the format
required for database integration:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read the SME validated mapping file from the user folder</span></span>
<span><span class="va">pharmacy_mapping</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"your_path_to/pharmacy_mapping_for_SME_validated.xlsx"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># #   row_id count             search_type                     raw_input rxnorm_match drug_group times_validated SME_confirm         SME_comment</span></span>
<span><span class="co"># # 1      1  1271 med_id_generic_name_raw               insulin regular      insulin    insulin              2+        TRUE</span></span>
<span><span class="co"># # 2      2   722 med_id_generic_name_raw             insulin humulin r      insulin    insulin              2+        TRUE</span></span>
<span><span class="co"># # 3      3   671 med_id_generic_name_raw tazocin (fk) 4.5g in 100ml ns      insulin    insulin               0        FALSE</span></span>
<span><span class="co"># # 4      4   600   med_id_brand_name_raw                         lilly      insulin    insulin               0        TRUE</span></span>
<span><span class="co"># # 5      5   332              med_id_din                      00586714      insulin    insulin               0        TRUE exclude from cohort</span></span>
<span></span>
<span><span class="co"># subset the file to contain only necessary columns</span></span>
<span><span class="va">pharmacy_mapping</span> <span class="op">&lt;-</span> <span class="va">pharmacy_mapping</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">search_type</span>, <span class="va">raw_input</span>, <span class="va">rxnorm_match</span>, <span class="va">SME_confirm</span>, <span class="va">drug_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ensure SME_confirm is a **logical variable** and remove non-TRUE values</span></span>
<span><span class="va">pharmacy_mapping</span> <span class="op">&lt;-</span> <span class="va">pharmacy_mapping</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SME_confirm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">SME_confirm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pharmacy_mapping</span> <span class="op">&lt;-</span> <span class="va">pharmacy_mapping</span><span class="op">[</span><span class="va">SME_confirm</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># write the updated file to a csv to the user folder</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span><span class="va">pharmacy_mapping</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"your_path_to/pharmacy_mapping_for_SME_validated_updated.csv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mappings-to-include">Mappings to include<a class="anchor" aria-label="anchor" href="#mappings-to-include"></a>
</h3>
<p>Note that NOT all types of mappings need to be included to the master
file. The only types of mapping we collect are <strong>True
positives</strong> and <strong>False negatives</strong> (if
applicable):</p>
<div style="padding-left:40px">

<p><br><strong>True positives</strong> are drug entries RxNorm correctly
identified. For example, the red-highlighted rows below are the true
positives and should be added to the master file:</p>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig11_masterfile_collection_truepos.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<pre><code>Essentially, they are the rows with `SME_confirm=TRUE`. Also note that, althought the SME commented to exclude the 5th row from the study, the 5th row is still a true positive match for insulin and thus should still be added. </code></pre>
<p>The expected formatted file, after the analyst filters mappings to
true positive rows:
<img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig12_masterfile_collection_truepos_clean.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
<br><br>If your study also examines unmatched results (i.e. running
<code><a href="../reference/rxnorm_query.html">rxnorm_query()</a></code> with <code>return_unmatched=T</code>), there
may have false negative mappings, which we are also interested to
collect.
<p>
</p>
<p><strong>False negatives</strong> are drug entries missed by RxNorm
and found by examining unmatched rows. In the mock example below, the
blue-highlighted row is an entry that RxNorm missed but was identified
as insulin by the SME.</p>
<p><img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig13_masterfile_collection_falseneg.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<pre><code>Analyst should perform additional preprocessing to append this entry to the final file along with the true positives. Namely, convert:
- `SME_mapped_search_type` to `search_type`, 
- the relevant drug entry to `raw_input`
- `SME_mapped_drug` to `rxnorm_match` while adding a prefix "manual_" to the drug name
- `SME_mapped_drug_group` to `drug_group`
- set `SME_confirm` to TRUE.</code></pre>
<p>The expected <em>final</em> formatted file for database upload
(containing both the true positives and the false negative entries):
<img src="figures/pharmacy_mapping/prepare_pharm_for_validation/fig14_masterfile_collection_falseneg_clean.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
</div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="section-db-upload">Using <code>GEMINIpkg::add_validated_pharm_map()</code> (GEMINI
Analysts Only)<a class="anchor" aria-label="anchor" href="#section-db-upload"></a>
</h2>
<details><summary><span style="color:#d13dcc; font-size:18px; font-weight:bold;"> Expand
section for database upload instructions </span>
</summary><p><strong><code>GEMINIpkg::add_validated_pharm_map()</code></strong>
was developed to accurately and efficiently append new validated
pharmacy mappings to the existing collection of pharmacy mappings stored
in the Pharmacy Mapping database.</p>
<p>Note that this function is ONLY available in the internal package
<code>GEMINIpkg</code> (not available in <code>Rgemini</code>). To use
this function, users will need to load the GEMINIpkg library to their
workspace or call <code>GEMINIpkg::add_validated_pharm_map()</code>.</p>
<p>The function runs a series of checks, processes validated pharmacy
mappings, and appends new mappings to the database. If the checks detect
any data issues, the user is provided with options to resolve them.</p>
<p>Newly validated rows can <strong>only</strong> be appended if the
<em>drug_group</em> field is fully populated
(i.e. <code>drug_group</code> is mandatory). The function provides a
convenient way to help users resolve the missing values in this
field.</p>
<details><summary><span style="color:blue; font-size:13px; margin-left: 20px;">Expand to
see important note about drug_group for analysts</span>
</summary><pre><code>Classifying drugs into groups is not always neccessary for individual research projects, so project SMEs are not required to fill out `drug_group`. 
However, high-level drug classification can often be beneficial for various research purposes. Therefore, filling out `drug_group` is required for mappings added to GEMINI's Pharmacy Master Mapping table and can be performed by GEMINI's internal SMEs. As there is no single "best" way to systemetically classify drugs, analysts are **not expected** to fill out the `drug_group` themselves. Instead, they should use the `add_validated_pharm_map()` function to extract existing classifications, and reach out to our SMEs to perform mapping for drugs that have not been previously grouped. This ensures that drugs are classified in a relatively consistent manner over time. See sections below for details.</code></pre>
</details><p>For new pharmacy mapping records that have passed the checks, the
function will <strong>append them to the Staging Pharmacy Mapping table
(<code>staging.working_pharmacy_mapping</code> in the
database)</strong>, along with the user’s database
<code>user_name</code>, <code>project_id</code>, and a timestamp
(<code>last_updated</code>). The added user information allows tracking
of records in case a revision is necessary.</p>
<p>Overall, the function prevents analysts from appending incorrect,
incomplete, or duplicate mappings to the Pharmacy Mapping Master table,
and provides analysts with both a more efficient and accurate way to
grow the existing collection of pharmacy mappings.</p>
<div class="section level3">
<h3 id="key-parameters-2">Key parameters<a class="anchor" aria-label="anchor" href="#key-parameters-2"></a>
</h3>
<p>There is only one parameter in the function:</p>
<p><strong><code>file_path</code></strong> - path for a .csv file
containing the newly validated pharmacy mapping records.</p>
<p><strong>NOTE</strong>:</p>
<ul>
<li><p>The csv file imported from the <code>file_path</code> parameter
must meet the formatting requirements in <a href="#section-db-prep"><em>Preparing SME-validated mappings for
database integration</em></a></p></li>
<li><p>There are implicit parameters users need to provide through
prompts when running the function:</p></li>
</ul>
<div style="margin: 0px 0px 0px 40px; font-size:13px">
<ol style="list-style-type: decimal">
<li>
<strong><code>Username</code></strong>: the username of the analyst
for their database connection.</li>
<li>
<strong><code>Password</code></strong>: the password of the analyst
for their database connection.</li>
<li>
<strong><code>Project Title</code></strong>: the Abbreviated Title
of the research project as per the GEMINI Project Tracker. If the
mapping is not associated with a project on the tracker, the user should
provide a brief name that describes the mapping activity,
e.g. ‘reports_sedhypno_indicator’.</li>
<li>
<strong><code>CSV Output Prompt</code></strong>: if the value
entered is <code>yes</code>, unmapped records without
<code>drug_group</code>, will be exported to a csv file. If the value
entered is anything else, the unmapped records will not be appended and
instead returned to the user’s R environment object.</li>
<li>
<strong><code>CSV Output Path</code></strong>: if the user chooses
to export records without <code>drug_group</code>, they must then enter
a path the csv file will be exported to.</li>
<li>
<strong><code>Final Confirmation</code></strong>: a final
confirmation that the user needs to provide. If
<strong>‘confirm’</strong> is entered, the function will append the new
validated pharmacy mapping records to the Staging Pharmacy Mapping file
in the database. If anything else is entered, nothing will be appended,
and the function will exit.</li>
</ol>
</div>
<ul>
<li>To ensure drugs are consistently classified into groups in the
master mappings table, the function detects and handles missing or
misaligned <code>drug_group</code> entries in the csv file. The
function:
<div style="margin: 0px 0px 0px 40px; font-size:13px">
<p>
<strong>(a)</strong> auto-fills missing drug_group values using existing
mappings from the master mapping table
</p>
<p>
<strong>(b)</strong> corrects entries where the provided drug_group
misaligned with the master mapping
</p>
<p>
<strong>(c)</strong> flags the remaining unmapped entries for users to
resolve them
</p>
<ul>
<li><p>Mapped entries from (a) and (b) will be appended to the database.
For unmapped entries from (c), the function allows users to either
export them to a file or interact with them in their R environment,
where they can then consult our SMEs to complete the mappings, which can
be uploaded to the database by re-running the function. For details,
please see the example in <a href="#section-db-upload-unmap"><em>Unmapped drug_group
variable</em></a>.</p></li>
<li><p>For users who prefer uploading everything at once, this process
may be adjusted, however, this is recommended only for those with a
thorough understanding of the function and confidence in reproducing the
steps. For example, users may manually query the
staging.working_pharmacy_mapping for existing drug_group and consult
with SME for mapping before running the function; or they may run the
function to perform the query, exit before the final confirmation step
to avoid uploading, and re-run the function to upload the completely
filled out mappings.</p></li>
</ul>
</div>
</li>
<li>The function can be terminated at any time (via [ctrl+c] on NORA)
without appending anything to the database.</li>
<li>Nothing is appended to the database until the very last step where
the user is prompted to type exactly <code>confirm</code>. Hence, if a
mistake was made when entering values for the function’s prompts, the
user can simply exit the function without making unintended database
changes.</li>
<li>The checking for existing copies of pharmacy mappings and the
appending of new pharmacy mappings are performed on the
<code>staging.working_pharmacy_mapping</code> database, not the
<code>pharmacy_master_mapping</code> database. The
<code>staging.working_pharmacy_mapping</code> will be used to update the
<code>pharmacy_master_mapping</code> database at various intervals in
time.</li>
<li>When a new version of
<code>drm_cleandb</code>/<code>gemini_h4h_template</code> is created,
the <code>lookup_pharmacy_mapping</code> table is updated according to
the newest version of the <code>pharmacy_master_mapping</code> DB.</li>
</ul>
</div>
<div class="section level3">
<h3 id="insulin-example-3">Insulin example<a class="anchor" aria-label="anchor" href="#insulin-example-3"></a>
</h3>
<p>Run the function on the cleaned file - the file user saved to folder
in the <a href="#section-db-prep">preparing step above</a>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">GEMINIpkg</span><span class="op">)</span> <span class="co"># load required package for the function</span></span>
<span></span>
<span><span class="fu">add_validated_pharm_map</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"your_path_to/pharmacy_mapping_for_SME_validated_updated.csv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><br>Upon running, the function will perform checks on the input file
and stops if any check fails.</p>
<details style="font-size:11px"><summary><span style="color:grey; font-size:12px; margin-left: 20px;">Expand to
see what happens when a check fails</span>
</summary><p>For example, if you do not filter for only SME_confirm == TRUE
records, then the function will stop and ask you to resolve the invalid
values. Invalid records are printed in the console - rows with
SME_confirm as NA:</p>
<p><img src="figures/pharmacy_mapping/add_validated_pharm_map/fig1_invalid_records_SME_not_TRUE_quit_error_message.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
<img src="figures/pharmacy_mapping/add_validated_pharm_map/fig2_invalid_records_SME_not_TRUE_table.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></details><p><br> After all checks are passed, you will be prompted to enter your
database Username, Password, and the Abbreviated Title of your
project:</p>
<p><img src="figures/pharmacy_mapping/add_validated_pharm_map/fig3_user_name_prompt.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
<p><br> Next, the function checks if any to-be-appended records already
exist in the Pharmacy Master Mapping file. Records with 2 or more copies
of the same mapping will not be appended. These records will be printed
in the console for user to review and acknowledge:
<img src="figures/pharmacy_mapping/add_validated_pharm_map/fig4_duplicate_mapping_entries_message_and_user_acknowledgement.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p><br> Afterwards, the final set of new records that will be appended
to the database is displayed in the Viewer for interactive review:
<img src="figures/pharmacy_mapping/add_validated_pharm_map/fig5_viewer_of_rows_to_be_appended.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p><br>The user will be prompted one final time to confirm the addition.
If ‘confirm’ is entered, the records will be added to the database. If
‘confirm’ is not entered, no records will be appended and the function
will exit.</p>
<p><img src="figures/pharmacy_mapping/add_validated_pharm_map/fig6_final_confirm_prompt.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="more-complex-scenarios-1">More complex scenarios<a class="anchor" aria-label="anchor" href="#more-complex-scenarios-1"></a>
</h3>
<div class="section level4">
<h4 id="section-db-upload-unmap">Unmapped <code>drug_group</code> variable<a class="anchor" aria-label="anchor" href="#section-db-upload-unmap"></a>
</h4>
<p>If there are rows where the <code>drug_group</code> variable has
missing records even after mapping with the Pharmacy Master Mapping file
in the database, the function allows the user to either output a csv
file containing the missing records for the SME to validate or output
the table of missing records into the R environment to investigate.</p>
<p>Here is an example of what happens when there is no
<code>drug_group</code> in the SME validated file, when running the
function:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### run the function on the newly updated file</span></span>
<span><span class="fu">add_validated_pharm_map</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"your_path_to/pharmacy_mapping_for_SME_validated_updated_no_drug_group.csv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><br>Unmapped <code>drug_group</code> records are printed in the
console and users have the option to export them into a csv file for the
SME to determine the <code>drug_group</code>. If ‘yes’ is entered, the
user will be prompted to enter the path for exporting the csv file:</p>
<p><img src="figures/pharmacy_mapping/add_validated_pharm_map/fig7_no_drug_group_export_prompt_yes.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p><br>If the user enters ‘no’ to the prompt, then the function will
proceed as usual without exporting the unmapped <code>drug_group</code>
rows, and the unmapped <code>drug_group</code> rows will be created in
the R environment as the object
<code>missing_drug_group_rows</code>:</p>
<p><img src="figures/pharmacy_mapping/add_validated_pharm_map/fig8_no_drug_group_export_prompt_no.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p>After this step (output/save the unmapped rows), the function will
proceed as usual: mapped rows will be appended to the database upon
‘confirm’, while unmapped rows will not.</p>
</div>
<div class="section level4">
<h4 id="making-changes-to-the-appended-records">Making changes to the appended records<a class="anchor" aria-label="anchor" href="#making-changes-to-the-appended-records"></a>
</h4>
<p>After appending to the Staging Pharmacy Mapping file in the database,
if a mistake was discovered, it is possible to make changes to the
records directly using SQL queries.</p>
<p><strong>Changes can only be made to records created by the respective
owner</strong>, as determined by the user’s unique database access
username in the <code>user_name</code> column. As a reminder, the
<code>user_name</code> column is automatically appended to the database
after a successful run of <code>add_validated_pharm_map()</code>. The
timestamp column, <code>last_updated</code> can also be used to help the
user identify rows to change.</p>
<p>For example, the user below realized that all oral anticoagulants
appended on 2024-11-01 were incorrect, the user removes them from the
database (so that they can be fixed and reappended using
<code>add_validated_pharm_map()</code>) by doing the following:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Connect to the pharmacy_mapping db</span></span>
<span><span class="va">drv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDriver.html" class="external-link">dbDriver</a></span><span class="op">(</span><span class="st">"PostgreSQL"</span><span class="op">)</span></span>
<span><span class="va">map_db_con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="va">drv</span>,</span>
<span>  dbname <span class="op">=</span> <span class="st">"pharmacy_mapping"</span>,</span>
<span>  host <span class="op">=</span> <span class="st">"domain_name.ca"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"username"</span>,</span>
<span>  password <span class="op">=</span> <span class="fu">getPass</span><span class="op">(</span><span class="st">"Enter Password:"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># First inspect the rows to be deleted</span></span>
<span><span class="va">rows_to_delete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">map_db_con</span>, <span class="st">"</span></span>
<span><span class="st">  SELECT *</span></span>
<span><span class="st">  FROM staging.working_pharmacy_mapping</span></span>
<span><span class="st">  WHERE user_name = 'username'</span></span>
<span><span class="st">    AND last_updated::date = '2024-11-01'</span></span>
<span><span class="st">    AND drug_group = 'oral anticoagulant';</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># An example of the returned rows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rows_to_delete</span><span class="op">)</span></span>
<span><span class="co">#   user_name             search_type              raw_input  rxnorm_match         drug_group        project_name        last_updated</span></span>
<span><span class="co"># 1   username med_id_generic_name_raw          acenocoumarol acenocoumarol oral anticoagulant GEMINI-Project-Name 2024-11-01 09:30:06</span></span>
<span><span class="co"># 2   username med_id_generic_name_raw               apixaban      apixaban oral anticoagulant GEMINI-Project-Name 2024-11-01 09:30:06</span></span>
<span><span class="co"># 3   username med_id_generic_name_raw    apixaban 2.5 mg tab      apixaban oral anticoagulant GEMINI-Project-Name 2024-11-01 09:30:06</span></span>
<span><span class="co"># 4   username med_id_generic_name_raw apixaban 2.5 mg tablet      apixaban oral anticoagulant GEMINI-Project-Name 2024-11-01 09:30:06</span></span>
<span><span class="co"># 5   username med_id_generic_name_raw      apixaban 5 mg tab      apixaban oral anticoagulant GEMINI-Project-Name 2024-11-01 09:30:06</span></span>
<span><span class="co"># 6   username med_id_generic_name_raw   apixaban 5 mg tablet      apixaban oral anticoagulant GEMINI-Project-Name 2024-11-01 09:30:06</span></span>
<span></span>
<span><span class="co">### Running the delete statement</span></span>
<span></span>
<span><span class="co"># When making changes to the database, please use 'BEGIN' statements with 'COMMIT' statements if changes are final.</span></span>
<span><span class="co"># Or use 'ROLLBACK' statements to abort the changes.</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">dbSendQuery</a></span><span class="op">(</span><span class="va">map_db_con</span>, <span class="st">"BEGIN;"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Delete the incorrectly appended rows</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">dbSendQuery</a></span><span class="op">(</span><span class="va">map_db_con</span>, <span class="st">"</span></span>
<span><span class="st">  DELETE FROM staging.working_pharmacy_mapping</span></span>
<span><span class="st">  WHERE user_name = 'username'</span></span>
<span><span class="st">    AND last_updated::date = '2024-11-01'</span></span>
<span><span class="st">    AND drug_group = 'oral anticoagulant';</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check that they no longer exist in the db.</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">map_db_con</span>, <span class="st">"</span></span>
<span><span class="st">  SELECT *</span></span>
<span><span class="st">  FROM staging.working_pharmacy_mapping</span></span>
<span><span class="st">  WHERE user_name = 'username'</span></span>
<span><span class="st">    AND last_updated::date = '2024-11-01'</span></span>
<span><span class="st">    AND drug_group = 'oral anticoagulant';</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If for any reason you don't want to proceed with these changes, run:</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">dbSendQuery</a></span><span class="op">(</span><span class="va">map_db_con</span>, <span class="st">"ROLLBACK;"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If the changes are final, then run:</span></span>
<span><span class="co"># dbSendQuery(map_db_con, "COMMIT;")</span></span></code></pre></div>
<p>After the incorrectly appended rows are removed from the staging
database, you can reappend a fixed version by re-running
<code>add_validated_pharm_map()</code>.</p>

<!-- styling HTML Workflow -->
<style type="text/css">

h1 { font-size: 26px; }

body{ /* Normal  */
  font-size: 14px;
  font-family: "Georgia", serif;
  line-height: 1.5;
  padding: 10px;
  margin-left: 450px;
  }

ul:not(#TOC ul) li  {
    margin-top: 8px;
  }

#TOC {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 300px;
    height: calc(100vh - 100px);
    overflow-y: auto;
    border: 1px solid #2a93dd;
    background-color: #ffffff;
    padding: 10px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    border-radius: 5px;
  }

</style>
</div>
</div>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by GEMINI.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
