---
title: "Introduction to statistical analyses with GEMINI data"
output:
  html_vignette:
    number_sections: true
    toc: true
    dfprint: kable

vignette: >
  %\VignetteIndexEntry{Statistics - Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


*  *  *  *


# Introduction & overview

This vignette illustrates an example analysis with (dummy) GEMINI data. The goal of this vignette is to provide an educational resource for analysts to make informed decisions at each analysis step. Throughout the vignette, we also provide links to existing resources with more detailed explanations.

If you would like to discuss any topics in more detail, please use the [Rgemini discussion forum](https://github.com/GEMINI-Medicine/Rgemini/discussions/categories/statistics)


*  *  *  *

# Research question & conceptual model 

In this tutorial, we will consider a hypothetical research study to investigate the question:

> **What is the effect of patients' age on clinical outcomes, in-hospital mortality, length of stay (LOS), among patients with pneumonia discharged between 2018 - 2020?**. 


## Study design

As a general first step in conducting a research study, researchers would carefully consider the study design most suitable for answering the research question. Although analysts typically do not come up the study design themselves, knowing the fundamentals of study designs would help in effective understanding of research proposals and communicating with PIs and other researchers. 

<br></br>
<details>
<summary>**Expand section to learn about study designs and data considerations**</summary>

- The choice of study design is critical as it sets the framework for conducting the research, directs the analysis method, and influences robustness and validity of the study findings. For example, a cohort study provides stronger evidence for causal relationships than a case-control study. 

- Below is a brief sketch of the core designs in clinical research. Check out these resources for a refresher on core study designs: [1](https://www.ncbi.nlm.nih.gov/books/NBK470342/), [2](https://doi.org/10.1016/S0140-6736(02)07283-5). Of note, although there are general core study designs, designs and their categorizations are not rigid, and there are more complex designs and grey areas that may not clearly distinguish one design from another.

```{r, echo=FALSE, out.width = "40%", fig.align = "center", fig.cap="Figure 1. Common Study Designs. <span style='color:grey; font-size:11px'> ([Grimes DA and Schulz KF. The Lancet, 2002](https://doi.org/10.1016/S0140-6736(02)07283-5)) </span> " }
knitr::include_graphics("figures/stat_vignette_study_design.png", dpi = 200)
```


- Clearly, the choice of study design is dependent on the nature of the data being used. 

  + In experimental studies, data collection is driven by specific research questions (researchers have control over participant recruitment, intervention assignment and measurements collection). 
  + In contrast, GEMINI data are sourced from **routine data** collected on the basis of hospital admissions primarily for administrative and clinical purposes, not tailored to answering any specific research question. 
  
  > <span style='font-size:12px'> **Routine data**: A major source of GEMINI data is routinely collected electronic health records (EHR). Thus, our data shares similar characteristics and considerations as other EHR-derived databases when conducting research. This topic is beyond the scope of this tutorial. Interest readers are encouraged to check out this [review](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6724703/) for a general overview using EHR-derived data for research (e.g. common terminology, data attributes, study designs, advantages and limitations. Note that the review article was written in a US setting but the discussed concepts are generally applicable). </span>

  + The nature of routine data makes GEMINI data particularly suitable for conducting **observational studies**. Below are some example observational studies conducted using GEMINI data:
    + Retrospective cohort: <span style='font-size:11px'> [Bai AD et al. CHEST, 2024](https://doi.org/10.1016/j.chest.2023.08.008). [McIntyre MT et al. CMAJ, 2023](https://doi.org/10.1503/cmaj.221732). [Doshi S et al. JAMA Intern Med., 2023](https://doi.org/10.1001/jamainternmed.2023.2629).</span>
    + Cross-sectional: <span style='font-size:11px'>[Razak F et al. CMAJ Open, 2020](https://doi.org/10.9778/cmajo.20200098), [Verma AA et al. CMAJ Open, 2019](https://doi.org/10.9778/cmajo.20180181)</span>
    + Other designs are possible (e.g. methodology, machine learning etc), see [GEMINI publications](https://geminimedicine.ca/publications/)

</details>
<br></br>

With knowledge about study designs and GEMINI data characteristics, let’s determine which study design would be suitable for addressing our research question.

- The exposure of interest is patient's age at admission. The outcomes of interest are in-hospital mortality and LOS.

- Experimental studies are not possible for this question (impossible for researchers to manipulate the exposure variable, age). The question is **observational** by nature, which is well suited for using GEMINI data.

- The question is looking to estimate the association (magnitude and direction) between patient's age at admission and their clinical outcomes. An analytical study rather than a descriptive study is required. Since in-hospital mortality and LOS can only be known after hospital admission, the temporal relationship between exposure and outcome is implied. Therefore, our research question calls for a **cohort study design**, which means that researchers would assemble a cohort of patients based on characteristics at admission (e.g. pneumonia) and then follow them over time for the occurrence of outcomes.

- As the outcomes of interest have already occurred upon data extraction, the cohort is considered retrospective.

- Therefore, a **retrospective cohort study** would be suitable for addressing the research question.


## DAG 

- Understand and visualize conceptual model (confirm that project proposal/analysis plan is sound and makes sense)
  - Draw DAG
  - Define each component (e.g., what are confounders?), link to resources for mediators
  - Discuss causality
  
- Consider relevant covariates/confounders/mediators -> explain rationale for adjusted vs. unadjusted estimates
- Covariates to include here (explain variables):
  - gender
  - admission season
  - Charlson comorbidity
  - mLAPS
  - admitted from ER
  - ...

  - 1 person to start with sekelton (Kayley)
  

```{r}

```

- Additional things to consider:
  - clustering by hospital?
  - additional confounders?
  - cohort considerations, additional exclusions/inclusions required?
    - e.g., GIM vs. all-med? ER entry... ? previous hospitalizations
    - exclude COVID patients (because study period starts before COVID -> don't want results to be confounded by COVID)



## Cohort definition

Based on the DAG above, the following exclusion/inclusion criteria will be applied below.
- Incl. 1: Hospitalizations with Pneumonia as most responsible diagnosis code (MRDx) ICD-10-CA code for pneumonia in in-patient diagnosis table (need to be provided by SME)
- Excl.?: Exclude post-admission pneumonia diagnoses???
- Incl. 2: Hospitalizations with available lab data (mLAPS)
- Incl. 3: Hospitalizations admitted via ED (to exclude hospital-acquired pneumonia)
- Excl. 1: Patients with hospitalization in previous 30 day period ("-")

-> rationale for exclusion/inclusion criteria needs to be clear here for section below, add more explanation

-> in collaboration with PI, multiple iterations based clinical knowledge/data checks etc. (e.g., discuss during kick-off meeting)

Anne

*  *  *  *

# Data checks & cohort generation

Now that we have clarified the conceptual framework, let's take a look at the data.

Here, we assume our baseline cohort consists of all GEMINI encounters from 32 hospitals and we'll load this dummy data from a saved file.

```{r}
# read sample data
data <- readRDS("R:/GEMINI/Research Projects/Rgemini/stats_vignette/dummy_data_stats.rds") %>% data.table()
```


We will start with some data quality/coverage checks and cohort generation. The steps in this section are not strictly sequential! Instead, data checks and cohort refinement typically go hand in hand based on an iterative process. Specifically, you will generally start with some basic checks/exploration on the whole dataset, then apply cohort inclusion/exclusion steps, then check the data for cohort-specific issues, which may cause you to refine your inclusions/exclusions etc. etc. ... and you may repeat this process several times before finalizing your cohort. Throughout that process, you will also derive additional variables/create relevant flags which should be included in your data checks to make sure all variables in your final cohort are ready to be analyzed.


## Check data coverage

Next, we'll check data coverage. Generally, this should be performed on the whole dataset (within relevant time period, 2018-2020), (prior to applying inclusion/exclusion steps).

A basic sanity check is to plot the number of encounters per hospital per month:

- don't use term "missing" here (clarify below)

```{r fig.width=12}
Rgemini::plot_over_time(data, func = "n")
```

**Things analysts should ask themselves when looking at these plots:**
1) How many hospitals are available for which periods of time?
2) Which hospitals have a large vs. small number of encounters (e.g., 102/121/131 have very few encounters)?
3) Are there any drastic changes in the number of encounters over time (which could reflect changes in the GEMINI cohort or potential biases introduced during cohort generation, see below)?


We should also check the individual columns by hospital * month, especially for variables that rely on clinical data (e.g., lab/pharmacy/vitals etc.) to make sure these data are consistently available across sites and time periods. 

For example, in our analyses, we want to include mLAPS as a covariate. Since mLAPS relies on lab data, it's possible there are certain hospitals/time periods without mLAPS values. This is illustrated in the following plot (note: `plot_over_time()` will also print a warning with all hospital * month combinations that have missing data):

```{r fig.width=12}
Rgemini::plot_over_time(data, plot_var = "mlaps") # note: you can also specify func = "na" to directly plot % missing entries
```


**Things analysts should ask themselves when looking at these plots:**
- Are there any hospitals/time periods where no lab data are available (even though administrative data may be available)?
  - E.g., hospitals 102/121 have no mLAPS values, 123/124 only have mLAPS values starting in 2019 etc.
- Are there any hospitals/time periods with implausible values/outliers?


## Apply cohort inclusions/exclusions

Next, we filter the cohort for all relevant encounters. In our example, we only want to include encounters with ICD-10-CA code = XXX:

-> change this 

```{r}
cohort <- data[ccsr_default == "RSP002", ]
```

As a sanity check, let's check what % of encounters from the original cohort this corresponds to:

```{r}
100*nrow(cohort)/nrow(data)
```
- To add: Filter by relevant time periods with available lab data (+ other inclusion/exclusion steps)


## Create additional derived variables

In the example dummy data, some derived variables have already been added (e.g., derived scores for Charlson Comorbidity, mLAPS, LOS, in-hospital mortality, CCSR condition for most responsible diagnosis code MRDx). 

Let's derive some additional covariates, like "admission season":

```{r}
data[, admission_season := Rgemini::season(admission_date_time)]
```


## Check variable distributions & missingness

Let's plot some basic descriptives and check the distribution & missingness of all relevant predictors/covariates and outcome variables:

```{r fig.height = 8, fig.width = 8}
Rgemini::plot_summary(cohort[, .(age, gender, mlaps, admit_charlson_derived, admitted_from_er, los_days_derived, in_hospital_mortality_derived, admission_season)])
```

**Things analysts should ask themselves when looking at these plots:**
- What % of entries are missing for each variable?
  - In our example, only mLAPS and Charlson Score have missing values
- What are possible reasons for missing entries?
  - mLAPS relies on lab entries, so one reason for missing entries might be that lab data are not available for certain hospitals/time periods (see below)
  - For CCI codes: In-patient diagnoses are generally available for all encounters, but diagnoses at admission may not be available if an encounter was not admitted via ED
- For continuous variables: Does the variable look normally distributed, or is it heavily skewed?
  - For example, the distribution of length of stay is heavily right-skewed (-> what to do?, links to existing resources)
- Do the frequencies/distributions generally line up with my knowledge about GEMINI data?
  - For example: Admission rate from ER is > 90%. This makes sense since GEMINI data largely represent patients with a General Internal Medicine touchpoint (or other medical subspecialties), the vast majority of whom are admitted from the ER
  
## Impute missing values

Difference between data coverage vs. missing values within time periods that have data coverage

- mLAPS: Impute missing values with 0 (if lab data generally available)
- CCI: with 0 


## Plot variables over time & by hospital (again)

... to make sure none of our inclusion/exclusion steps caused any potential biases
E.g., let's say we would want to analyze trends over time: We would want to make sure we are including the same time period from all hospitals

```{r fig.width=12}
Rgemini::plot_over_time(data, plot_var = "mlaps") # note: you can also specify func = "na" to directly plot % missing entries
```

-> adjust cohort again if necessary/perform imputation



- checks:
  - data coverage
  - missing values
  - data types
  - derived variables (categorical sex)
  - outliers
  


*  *  *  *

# Descriptive statistics

- Generate table1 and descriptive plots (but no outcome peeking) 
- Double check that numbers match up across all variables
- Confirm that our cohort has sample size to support the analysis. 

```{r}

```


*  *  *  *

# Regression model

- Fit a-priori regression models (informed by question & variable types -> decision tree illustrating different variable types and appropriate models)
- Verify regression model assumptions are met 
- Link to resources on hypothesis testing (e.g., how to interpret p-values correctly, correcting for multiple comparisons, p-hacking etc.)
- center/standardize predictors?

```{r}

```

- Do whatever other analyses (subgroups?) 
- Wherever you can, functionalize your code if you are doing the same thing over and over again 

```{r}

```


*  *  *  *

# Result visualization & interpretation

- Identify important plots, make those plots 
- Think about uncertainty (do my estimates have measure of uncertainty? If not, find way to calculate SE.)
- Check results against my intuition about what they should be, spot check randomly like this 
- Incorporate results back into the clinician’s conceptual framework so I can explain the results in their language and emphasize things that matter to them, and downplay things they don’t need to understand [iterative] 

```{r}

```


*  *  *  *

# References & resources

- https://bookdown.org/rwnahhas/RMPH/




