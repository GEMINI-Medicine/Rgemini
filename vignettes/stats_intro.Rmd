---
title: "Introduction to statistical analyses with GEMINI data"
output:
  html_vignette:
    number_sections: true
    toc: true
    toc_depth: 3
    dfprint: kable

vignette: >
  %\VignetteIndexEntry{Statistics - Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)

library(data.table)
library(dplyr)
library(Rgemini)
library(lubridate)
library(kableExtra)

#rmarkdown::render("~/GitHub/Rgemini/vignettes/stats_intro.Rmd", output_dir = "/mnt/nfs/projects/research_projects/Rgemini/stats_vignette/")

```


*  *  *  *


# Introduction & overview

This vignette illustrates an example analysis with (dummy) GEMINI data. The goal of this vignette is to provide an educational resource for analysts to make informed decisions at each analysis step. Throughout the vignette, we also provide links to existing resources with more detailed explanations.

If you would like to discuss any topics in more detail, please use the [Rgemini discussion forum](https://github.com/GEMINI-Medicine/Rgemini/discussions/categories/statistics)


*  *  *  *

# Research question & conceptual model 

- Research question: What is the effect of patients' age on clinical outcomes (mortality/LOS) among patients with community acquired pneumonia discharged between 2018 - 2020?

- Study design: retrospective cohort study -> link to epidemiology resources for other designs (e.g., cross-sectional? case control?)
- Give examples of GEMINI projects for different designs

- Bijun

## DAG 

- Understand and visualize conceptual model (confirm that project proposal/analysis plan is sound and makes sense)
  - Draw DAG
  - Define each component (e.g., what are confounders?), link to resources for mediators
  - Discuss causality
  
- Consider relevant covariates/confounders/mediators -> explain rationale for adjusted vs. unadjusted estimates
- Covariates to include here (explain variables):
  - gender
  - admission season
  - Charlson comorbidity
  - mLAPS
  - admitted from ER
  - ...

  - 1 person to start with sekelton (Kayley)
  

```{r}

```

- Additional things to consider:
  - clustering by hospital?
  - additional confounders?
  - cohort considerations, additional exclusions/inclusions required?
    - e.g., GIM vs. all-med? ER entry... ? previous hospitalizations
    - exclude COVID patients (because study period starts before COVID -> don't want results to be confounded by COVID)



## Cohort definition

Based on the conceptual model discussed above, we will define our cohort as follows:

+ **Inclusion steps**
  - Incl. 1: All GIM encounters discharged between Apr 2018 - Apr 2020
  - Incl. 2: Hospitals with high data coverage for relevant variables (here: administrative & lab data for `mlaps`)
  - Incl. 3: Encounters with Pneumonia as most responsible diagnosis code (MRDx)

+ **Exclusion steps:**
  - Excl. 1: Encounters transferred from another acute-care institute 
  - Excl. 2: Encounters not admitted from ED
  
The reason for the two exclusion steps is to make sure that any covariates we include as baseline characteristics (e.g., `mlaps` at admission) accurately reflect patients' condition when they first entered the hospital (rather than having received prior treatment at another healthcare facility they were transferred from). 


The cohort inclusion/exclusion steps should be developed in close collaboration between the clinical researcher and data analyst. Typically, the steps will need to be refined during the project kick-off meeting to make sure the specific criteria, sequence, and rationale for the cohort definition makes sense. The cohort creation steps may also need to be refined once the analyst has completed the data checks (see next section), which might reveal unforeseen challenges/data issues.


*  *  *  *

# Data checks & cohort generation

Now that we have clarified the conceptual framework and cohort definition, let's take a look at the data.

Here, we assume our baseline cohort consists of all GIM encounters discharged between Apr 2018 - Apr 2020 (see incl. 1 above) from 20 hospitals. We'll load this dummy data from a saved file and turn it into a `data.table` object:

```{r}
# read sample data
data <- readRDS("/mnt/nfs/projects/research_projects/Rgemini/stats_vignette/dummy_data_stats.rds") %>% 
  data.table()
```


Next, we will perform some data quality/coverage checks and create our cohort. The steps in the sections below are not strictly sequential! Instead, data checks and cohort refinement typically go hand in hand based on an iterative process. Specifically, you will generally start with some basic checks/exploration on the whole dataset, then apply cohort inclusion/exclusion steps, then check the data for cohort-specific issues, which may cause you to refine your inclusions/exclusions etc. etc. ... Throughout that process, you will also derive additional variables/create relevant flags which should be included in your data checks to make sure all variables in your final cohort are ready to be analyzed.


## Check data coverage

First, we'll check data coverage. Generally, this should be performed on the whole dataset within the relevant cohort period (2018-2020), prior to applying any additional inclusion/exclusion steps.

We typically check coverage by plotting variables by hospital * discharge month (because GEMINI data are pulled based on patients' discharge dates).


### Number of encounters 

A basic sanity check is to plot the number of encounters per hospital per month:

```{r}
Rgemini::plot_over_time(data, func = "n")
```

&nbsp;

**These plots can provide important insights into:**

1) **Data coverage:** Certain hospitals may not have any (administrative) data during certain time periods.
2) **Patient volume:** Some hospitals might have a very large/small number of encounters overall, which is important to consider for the analyses below (e.g., small community hospitals will generally contribute fewer encounters to the overall cohort than large academic hospitals).
3) **Changes in the cohort over time:** For example, you might observe sudden drops/increases in encounter numbers, which might be due to seasonal changes, COVID-related factors, changes in the GEMINI cohort definition (e.g., expansion from GIM to all-medicine), or potential biases introduced during cohort inclusion/exclusion steps (see below).


In our example data, we can see that sites 6, 9, 10, and 12 do not have any encounters during certain time periods, indicating gaps in data coverage. We will therefore exclude these sites to make sure we have consistent data timelines across all hospitals.


### Clinical data coverage 

Even if a hospital has a large number of encounters during certain time periods, this does not necessarily mean that GEMINI has all relevant variables for these encounters. This is particularly relevant for clinical data (e.g., lab/pharmacy/vitals/transfusions etc.), which may have low coverage for certain hospitals and time periods. Therefore, we should also check data coverage for any relevant clinical variables, or specific columns of interest that may have missing values. 

For example, in our analyses, we want to include mLAPS as a covariate. Since mLAPS relies on lab data, it's possible there are certain hospitals/time periods without mLAPS values. Therefore, we'll plot the % of encounters that have a missing `mlaps` value (ignoring the sites we already excluded due to gaps in the administrative data):

```{r}
Rgemini::plot_over_time(data[!hospital_num %in% c(6, 9, 10, 12)], plot_var = "mlaps", func = "na")
```

As shown in the figure above, hospitals 15 and 17 have a high percentage of missing mLAPS data during certain time periods. You should confirm that this is due to missing lab data (instead of mistakes in the derived `mlaps` variable). For example, you can use the `Rgemini::data_coverage()` function [**coming soon**] to check data coverage for any database table of interest. Here, we will exclude those sites 15 and 17 due to gaps in the lab data coverage.


## Apply cohort inclusions/exclusions

Next, we filter the cohort for all relevant encounters based on the inclusion/exclusion steps listed above. 

To facilitate this process, let's derive a flag for each `genc_id` indicating whether that encounter meets a given inclusion/exclusion criterion.

### Incl. 1: GIM encounters between 2018 - 2020

In our case, this corresponds to all encounters in the dummy data.

```{r}
data[, incl1_gim := TRUE]
```

### Incl. 2: Hospitals with data coverage

Here, we include all sites that passed the data coverage checks from the previous section: 

```{r}
data[, incl2_coverage := !hospital_num %in% c(6, 9, 10, 12, 15, 17)]
```


### Incl. 3: Pneumonia diagnosis

When filtering by ICD-10-CA diagnosis codes, please consider the following questions:

**1. What diagnosis codes to include/exclude?** 
This is usually determined by an SME who will provide you with a list of relevant ICD-10-CA codes. In our example, all ICD-10-CA codes from J10-J18 should be included for pneumonia. Usually, you should filter for all diagnosis codes that **start** with the same characters (i.e., including children codes like "J12.8"), unless otherwise specified. If you are unsure, please clarify with the SME. 

**2. Is the diagnosis type relevant?** 
In our example, the cohort definition specifies "Pneumonia as a most responsible diagnosis code (MRDx)". We therefore need to filter by `diagnosis_type = M`. According to (HSMR methodology)[https://www.cihi.ca/sites/default/files/document/hospital-standardized-mortality-ratio-meth-notes-en.pdf] `diagnosis_type = 6` (Proxy MRDx) should also be included and takes priority over type-M.

**3. Do you only want to filter by in-patient diagnosis codes or also include ED diagnoses?**  
When filtering for a specific condition based on patient's MRDx, we typically only include in-patient diagnoses as they tend to be more reliable compared to ED diagnoses. However, this decision may be project specific, and in certain cases it might make sense to consider ED diagnoses to increase sensitivity. If you are unsure, please discuss this with the SME. 

The example data was already prefiltered for in-patient MRDx codes, so here we simply filter for the relevant diagnosis codes that start with J10-J18:

```{r}
data[, incl3_pneumonia := grepl("^J12|^J13|^J14|^J15|^J16|^J17|^J18", ipdiagnosis_mrdx)]
```


### Excl. 1: Acute-care transfer in

In our dummy `data` table, this is defined by `acute_transfer_in`, which is derived based on whether the `genc_id` has an entry in `lookup_transfers` where `acute_transfer_in = TRUE`:

```{r}
data[, excl1_transfer := acute_transfer_in]
```


### Excl. 2: Not admitted from ED

In our dummy `data` table, this is defined by `admitted_from_er`, which is a flag indicating whether or not a given `genc_id` has an entry in the `er` table:

```{r}
data[, excl2_ed := !admitted_from_er]
```



Let's make sure there are no missing values in any of the derived inclusion/exclusion flags (missing values would indicate that certain flags can't be defined for some `genc_ids`, in which case you should carefully check all variables that are required for the cohort definition):


```{r}
Rgemini::n_missing(data[,.(incl1_gim, incl2_coverage, incl3_pneumonia, excl1_transfer, excl2_ed)])
```


&nbsp;

Here, we don't have any missing values in any of the inclusion/exclusion flags, so we can go ahead and build our cohort as follows: 

```{r echo = FALSE}
## Note: This will be added to Rgemini soon...
cohort_creation <- function(
    cohort,
    labels,
    exclusion_flag = NULL,
    show_prct = TRUE,
    group_var = NULL,
    ...) {

  ## if no exclusion flags provided, interpret all steps as "inclusions"
  if (is.null(exclusion_flag)) {
    exclusion_flag <- c(rep(FALSE, length(cohort)))
  }

  ## check user input
  Rgemini:::check_input(cohort, "list")
  Rgemini:::check_input(labels, "character")
  Rgemini:::check_input(list(exclusion_flag, show_prct), "logical")
  if (!is.null(group_var)) {
    Rgemini:::check_input(group_var, "charater")
  }

  if (length(cohort) != length(labels) | length(cohort) != length(exclusion_flag)) {
    stop("The `cohort`, `labels`, and `exclusion_flag` (if provided) inputs need to have the same length.")
  }

  create_cohort <- function(cohort, exclusion_flag, group_var, ...) {

    ## get number of rows at each cohort creation step (= usually number of unique genc_ids)
    N <- sapply(cohort, nrow)

    ## calculate change in N between steps
    cohort_tab <- data.table(N, previous_n = lag(N))
    cohort_tab[, `%` := 100 * N / previous_n]

    ## for any steps with exclusion_flag = TRUE, show removal as -n (-X%)
    cohort_tab[exclusion_flag == TRUE & !is.na(previous_n), N := -(previous_n - N)]
    cohort_tab[exclusion_flag == TRUE & !is.na(previous_n), `%` := -(100 - `%`)]

    ## combine N (%, if show_prct = TRUE)
    cohort_tab[, `N (%)` := ifelse(
      !is.na(`%`) & show_prct == TRUE, paste0(prettyNum(N, ...), " (", round(`%`, 1), "%)"), prettyNum(N, ...)
    )]
    cohort_tab <- cohort_tab[, .(`N (%)`)]

    ## add row with final cohort number
    # (only needed if last step was showing exclusion)
    if (exclusion_flag[length(exclusion_flag)] == TRUE) {
      cohort_tab <- rbind(
        cohort_tab,
        data.table(`N (%)` = prettyNum(nrow(cohort[[length(cohort)]]), ...))
      )
    }

    if (!is.null(group_var)) {
      if (length(unique(unique(cohort[[1]][[group_var]]))) == 1) {
        colnames(cohort_tab) <- paste(group_var, "=", as.character(unique(cohort[[1]][[group_var]])))
      }
    }

    return(cohort_tab)
  }


  ## create table for overall cohort
  cohort_tab <- create_cohort(cohort, exclusion_flag, group_var, ...)

  ## add columns by subgroup (if group_var specified)
  if (!is.null(group_var)) {
    groups <- unique(cohort[[1]][[group_var]])
    grouped_list <- list()
    for (i in groups) {
      grouped_list[[i]] <- lapply(cohort, function(x) x[get(group_var) == i])
    }
    cohort_tab_grouped <- lapply(
      grouped_list, create_cohort,
      exclusion_flag = exclusion_flag, group_var = group_var, ...
    )
    cohort_tab_grouped <- do.call(cbind, cohort_tab_grouped)
    cohort_tab <- cbind(cohort_tab, cohort_tab_grouped)
  }

  ## add column with inclusion/exclusion step number
  steps <- c(ifelse(
    exclusion_flag == TRUE,
    paste("Excl. ", ave(seq_along(exclusion_flag), exclusion_flag, FUN = seq_along), sep = ""),
    paste("Incl. ", ave(seq_along(exclusion_flag), exclusion_flag, FUN = seq_along), sep = "")
  ), if (exclusion_flag[length(exclusion_flag)] == TRUE) "")

  labels <- c(labels, if (exclusion_flag[length(exclusion_flag)] == TRUE) "Final cohort")

  cohort_tab <- cbind(
    steps,
    labels,
    cohort_tab
  )

  ## Fix column names
  colnames(cohort_tab)[1:3] <- c("", "Cohort creation step", ifelse(show_prct == TRUE, "N (%)", "N"))
  if (!is.null(group_var)) {
    colnames(cohort_tab)[3] <- paste("Overall", colnames(cohort_tab)[3])
  }

  return(cohort_tab)
}
```

```{r}
cohort_table <- cohort_creation(
  cohort = list(data[incl1_gim == TRUE], # baseline cohort (discharges between 2018 - 2020)
                data[incl2_coverage == TRUE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE & excl2_ed == FALSE]),
  labels = c("All GEMINI encounters discharged between Apr 2018 - March 2020",
             "Encounters from hospitals with high data coverage",
             "Encounters with Pneumonia MRDx",
             "Encounters with an acute-care transfer",
             "Encounters not admitted from the ED"
             ),
  exclusion_flag = c(FALSE, FALSE, FALSE, TRUE, TRUE),
  big.mark = ","
)

cohort_table %>% knitr::kable(escape = FALSE, format = "html") %>%
  kable_styling("hover") %>%
  row_spec(6,  bold = TRUE)

```

## Get final cohort

Let's combine all inclusion/exclusion steps and create a new table that only contains encounters that are part of the cohort.

```{r}
cohort <- data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE & excl2_ed == FALSE]
```

We should make sure the number of rows in this table corresponds to what's shown in the last row of the cohort creation table above:

```{r}
nrow(cohort)
```


## Check variable distributions & missingness

Now that we have created the cohort, we should plot some basic descriptive statistics to check the distribution & missingness of all relevant predictors/covariates and outcome variables.

```{r}
Rgemini::plot_summary(cohort[, .(age, gender, mlaps, admit_charlson_derived, los_days_derived, in_hospital_mortality_derived)])
```

&nbsp;

**This plot provides important insights into:**

1) **% of entries with missing values:** In our data, only `mlaps` has missing values (see next section)
2) **Whether the variables are of the expected type (e.g., categorical vs. continuous):** For example, gender is categorical with 3 levels (M/F/O)
3) **Whether continuous variables are within the expected range or whether there are any implausible values:** For example, in our case, all continuous variables should have values >= 0 (or >= 18 in the case of age) and Charlson Comorbidity Index should be an integer between 0-24
4) **Whether continuous variables are normally distributed or heavily skewed, and whether there are any outliers:** For example, length of stay is heavily right-skewed and there are some extreme values with > 356 days


## Handling missing values

Let's first take a closer look at missing values. We need to carefully consider what the reason for missing values is in order to make an informed decision about how to deal with them.

Specifically, for `mlaps`, values are missing for any `genc_ids` that do not have any lab entries for relevant tests performed in the ED. This could be due to the following reasons:

1) **The encounter was not admitted via the ED.** These encounters were excluded from our cohort, so this does not apply here.
2) **GEMINI data does not have lab data available for that encounter.** We already checked missingness of `mlaps` above. For all hospitals we included, missingness was generally low (<10%) so we can assume that lab data coverage was generally high.
3) **Tests were not performed.** If we can rule out 1) and 2), the reason for why individual `genc_ids` don't have an `mlaps` value is likely because testing was not indicated (e.g., when the patient was admitted, the physician did not order any tests included in the `mlaps` calculation).

Since we can rule out 1) and 2) in our example, we can assume that testing was not indicated for `genc_ids` with missing `mlaps`. We will therefore impute missing `mlaps` with 0 here, indicating that the encounter likely would have had normal results on all relevant mLAPS tests:

```{r}
cohort[is.na(mlaps), mlaps := 0]
```


**Note: The distinction because "data coverage" vs. "missing values" is crucial here!** Even when data coverage is generally high, individual entries may still have missing values. For time periods with high data coverage, we can often make certain assumptions about missing values based on the clinical context, allowing us to perform imputation.

In our scenario, missingness of `mlaps` represents an example of "systematic missingness" (i.e., the missingness of certain values is not random, but rather, directly related to other clinically relevant variables, such as the patients' overall condition).

In other scenarios, missingness might be random. In that case, we may decide to handle missing values differently, for example by using a complete-case analysis design or performing multiple imputation. See [here](https://onlinecjc.ca/article/S0828-282X(20)31111-9/fulltext#:~:text=Missing%20data%20is%20a%20common,all%20subjects%20in%20the%20sample) for a more detailed discussion on this.


## Removing outliers

In the summary plot above, we can see that there are some encounters with extremely long length of stay (LOS). To remove any bias these outliers might introduce in the model (and because extremely long LOS typically indicates additional complications we may not be able to appropriately account for), we will exclude any encounters with long LOS. Here, we choose LOS <= 90 days as a cut-off, but you should discuss these criteria with a clinical expert:

```{r}
data[, exclude_los := los_days_derived > 90]

cohort_table <- cohort_creation(
  cohort = list(data[incl1_gim == TRUE], # baseline cohort (discharges between 2018 - 2020)
                data[incl2_coverage == TRUE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE & excl2_ed == FALSE],
                data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE & excl2_ed == FALSE & exclude_los == FALSE]),
  labels = c("All GEMINI encounters discharged between Apr 2018 - March 2020",
             "Encounters from hospitals with high data coverage",
             "Encounters with Pneumonia MRDx",
             "Encounters with an acute-care transfer",
             "Encounters not admitted from the ED",
             "Encounters with LOS > 90 days"
             ),
  exclusion_flag = c(FALSE, FALSE, FALSE, TRUE, TRUE, TRUE),
  big.mark = ","
)

cohort_table %>% knitr::kable(escape = FALSE, format = "html") %>%
  kable_styling("hover") %>%
  row_spec(7,  bold = TRUE)
```

Adjust cohort table to exclude encounters with extreme LOS: 

```{r}
cohort <- data[incl2_coverage == TRUE & incl3_pneumonia == TRUE & excl1_transfer == FALSE & excl2_ed == FALSE & exclude_los == FALSE]
```



## Final checks: Plot variables over time & by hospital (again)

In the previous steps, we've created the cohort and performed some data preprocessing. Let's plot some relevant variables over time (again) to check whether there are any weird time trends that may introduce biases. This is also a good way to double check whether any of our inclusion/exclusion steps may have introduced unexepcted patterns in our data.

As an example, we'll just plot `mlaps` here again. We would expect this variable to remain fairly stable over time (with some noise). Since we already checked for lab data coverage, we would not expect there to be any time periods with missing entries.


```{r}
Rgemini::plot_over_time(cohort, plot_var = "mlaps", func = "mean")
```
  


*  *  *  *

# Descriptive statistics

- Generate table1 and descriptive plots (but no outcome peeking) 
- Double check that numbers match up across all variables
- Confirm that our cohort has sample size to support the analysis. 

```{r}

```


*  *  *  *

# Regression model

- Fit a-priori regression models (informed by question & variable types -> decision tree illustrating different variable types and appropriate models)
- Verify regression model assumptions are met 
- Link to resources on hypothesis testing (e.g., how to interpret p-values correctly, correcting for multiple comparisons, p-hacking etc.)
- center/standardize predictors?

```{r}

```

- Do whatever other analyses (subgroups?) 
- Wherever you can, functionalize your code if you are doing the same thing over and over again 

```{r}

```


*  *  *  *

# Result visualization & interpretation

- Identify important plots, make those plots 
- Think about uncertainty (do my estimates have measure of uncertainty? If not, find way to calculate SE.)
- Check results against my intuition about what they should be, spot check randomly like this 
- Incorporate results back into the clinician’s conceptual framework so I can explain the results in their language and emphasize things that matter to them, and downplay things they don’t need to understand [iterative] 

```{r}

```


*  *  *  *

# References & resources

- Missing data: https://onlinecjc.ca/article/S0828-282X(20)31111-9/fulltext#:~:text=Missing%20data%20is%20a%20common,all%20subjects%20in%20the%20sample
- Introduction to regression analyses: https://bookdown.org/rwnahhas/RMPH/



