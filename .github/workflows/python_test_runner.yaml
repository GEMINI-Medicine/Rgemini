name: Run Rgemini tests via Python (rpy2)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]

jobs:
  test-rgemini-with-python:
    name: Test Rgemini with Python/rpy2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install necessary system dependencies for R packages like 'ragg'
      - name: Install system dependencies for R packages
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev

      # Set up the R environment
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release' # Use 'release' for the latest stable R version
          use-public-rspm: true

      # Set up the Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Or your desired Python version

      # Install the rpy2 Python package
      - name: Install Python dependencies (rpy2)
        run: pip install rpy2

      # Install R package dependencies, including devtools and testthat
      # This step also installs the Rgemini package's dependencies
      - name: Install R package dependencies (devtools, testthat, and Rgemini's deps)
        env:
          # Temporarily set R_PROFILE_USER to ensure packages are installed
          # into a standard library path accessible by rpy2.
          # We'll use a temporary file for this.
          R_PROFILE_USER: ${{ runner.temp }}/.Rprofile_gha
        run: |
          # Create a temporary .Rprofile to set the library path
          echo "options(repos = c(CRAN = 'https://cloud.r-project.org/'), download.file.method = 'libcurl')" > ${{ env.R_PROFILE_USER }}
          # Ensure packages are installed into the default user library path
          echo ".libPaths(c(Sys.getenv('R_LIBS_USER'), .libPaths()))" >> ${{ env.R_PROFILE_USER }}

          # Install required packages for testing and dependency management
          Rscript -e "install.packages(c('remotes', 'devtools', 'testthat'), Ncpus=2)"

          # Install Rgemini's dependencies listed in DESCRIPTION
          Rscript -e "remotes::install_deps(dependencies = TRUE, Ncpus=2)"
        working-directory: ${{ github.workspace }} # Ensure commands run from the repo root

      # Install the Rgemini package itself
      - name: Install Rgemini package
        env:
          # Use the temporary R_PROFILE_USER again for consistent library path
          R_PROFILE_USER: ${{ runner.temp }}/.Rprofile_gha
        run: |
          R CMD INSTALL .
        working-directory: ${{ github.workspace }}

      # Run the R tests using the Python script
      - name: Run Rgemini tests with Python script
        env:
          # Explicitly set R_HOME for rpy2. This is crucial.
          R_HOME: ${{ steps.setup_r.outputs.r-home }}
          # Explicitly set LD_LIBRARY_PATH for Linux to find R shared libraries.
          # This ensures that the dynamic linker finds libR.so from the R version setup by actions/setup-r.
          # The construction ensures we prepend to any existing LD_LIBRARY_PATH.
          LD_LIBRARY_PATH: ${{ steps.setup_r.outputs.r-home }}/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
          # R_LIBS_USER is automatically set by actions/setup-r and R's defaults,
          # and packages were installed there in the previous steps.
          # No need to explicitly set R_LIBS_USER here unless you have a specific reason.
        run: |
          echo "Executing Python script with:"
          echo "R_HOME=$R_HOME"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
          echo "Python executable: $(which python)"
          echo "Python version: $(python --version)"

          # Execute the Python script
          python .github/scripts/run_rgemini_tests.py
