name: Run Rgemini tests via Python (rpy2)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]

jobs:
  test-rgemini-with-python:
    name: Test Rgemini with Python/rpy2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies for R packages
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev libxml2-dev

      # Set up the R environment
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release' # Use 'release' for the latest stable R version
          use-public-rspm: true

      # Set up the Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Or your desired Python version

      # Install the rpy2 Python package
      - name: Install Python dependencies (rpy2)
        run: pip install rpy2

      # Install R package dependencies, including devtools and testthat
      # This step also installs the Rgemini package's dependencies
      - name: Install R package dependencies (devtools, testthat, and Rgemini's deps)
        env:
          # Add environment variables that might help with compilation
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          CPPFLAGS: -I/usr/include/libxml2
          # R_LIBS_USER is set at the job level and will be used by install.packages and remotes::install_deps
        run: |
          # Set CRAN repo and download method
          Rscript -e "options(repos = c(CRAN = 'https://cloud.r-project.org/'), download.file.method = 'libcurl')"

          # Install required packages for testing and dependency management
          Rscript -e "install.packages(c('remotes', 'devtools', 'testthat'), Ncpus=2)"

          # Install Rgemini's dependencies listed in DESCRIPTION
          Rscript -e "remotes::install_deps(dependencies = TRUE, Ncpus=2, upgrade = TRUE)"
        working-directory: ${{ github.workspace }} # Ensure commands run from the repo root

      # Install the Rgemini package itself
      - name: Install Rgemini package
        # R_LIBS_USER is set at the job level and will be used by R CMD INSTALL
        run: |
          R CMD INSTALL .
        working-directory: ${{ github.workspace }}

      # Run the R tests using the Python script
      - name: Run Rgemini tests with Python script
        env:
          # Explicitly set R_HOME for rpy2. This is crucial.
          R_HOME: ${{ steps.setup_r.outputs.r-home }}
          # Explicitly set LD_LIBRARY_PATH for Linux to find R shared libraries.
          LD_LIBRARY_PATH: ${{ steps.setup_r.outputs.r-home }}/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
          # Ensure R_LIBS_USER is set so rpy2's R session can find installed packages
          R_LIBS_USER: ${{ env.R_LIBS_USER }}
        run: |
          echo "Executing Python script with:"
          echo "R_HOME=$R_HOME"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
          echo "R_LIBS_USER=$R_LIBS_USER" # Echo for verification
          echo "Python executable: $(which python)"
          echo "Python version: $(python --version)"

          # Execute the Python script
          python .github/scripts/run_rgemini_tests.py